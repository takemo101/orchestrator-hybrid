# バックエンド出力のリアルタイムストリーミング

## 背景

`orch logs`コマンドで**実行中のOpenCode/Claudeの出力をリアルタイムで確認したい**。

現状は完了後のログしか見れず、長時間実行時にユーザーが進捗を把握できない。

## 実装状況

### 実装済み

| コンポーネント | ファイル | 状態 |
|---------------|---------|------|
| `BackendOutputStreamer` | `src/core/backend-output-streamer.ts` | ✅ 実装済み |
| `exec.ts` ストリーミング対応 | `src/core/exec.ts` | ✅ 実装済み |
| Claudeアダプター | `src/adapters/claude.ts` | ✅ `outputStreamer`オプション対応 |
| OpenCodeアダプター | `src/adapters/opencode.ts` | ✅ `outputStreamer`オプション対応 |

### 未実装（配線されていない）

| コンポーネント | ファイル | 状態 |
|---------------|---------|------|
| loop.tsでの接続 | `src/core/loop.ts` | ❌ **未接続** |
| orch logsでのリアルタイム表示 | `src/cli-logs.ts` | ❌ 未実装 |

## 残作業

### 1. loop.tsでBackendOutputStreamerを接続

```typescript
// src/core/loop.ts
import { BackendOutputStreamer } from "./backend-output-streamer.js";

// ループ開始時にストリーマーを作成
const outputStreamer = new BackendOutputStreamer({
  logDir: context.logDir,  // 例: .agent/task-xxx-42/
  stdoutFile: "backend-stdout.log",
  stderrFile: "backend-stderr.log",
});

// バックエンドに渡す
const backend = createBackend(config.backend, { outputStreamer });
```

### 2. orch logsでリアルタイム監視

```bash
# 実行中タスクのAI出力をリアルタイム表示
orch logs -t <task-id>

# 省略時は実行中タスクを自動選択
orch logs
```

内部では `.agent/<task-id>/backend-stdout.log` を `tail -f` 的に読む。

## 工数見積もり

| 作業 | 工数 |
|------|------|
| loop.tsでの接続 | 1時間 |
| orch logsのリアルタイム対応 | 2時間 |
| テスト | 2時間 |
| **合計** | 5時間 |

## 関連ファイル

- `src/core/backend-output-streamer.ts` - ストリーマー実装
- `src/core/exec.ts` - ストリーミング対応済み
- `src/adapters/claude.ts` - outputStreamerオプション対応済み
- `src/adapters/opencode.ts` - outputStreamerオプション対応済み
- `src/core/loop.ts` - **要修正**
- `src/cli-logs.ts` - **要修正**

## 優先度

**高** - パーツは揃っているので、配線するだけで動く状態。
