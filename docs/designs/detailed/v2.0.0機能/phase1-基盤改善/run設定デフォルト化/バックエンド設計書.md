# run設定デフォルト化 バックエンド設計書

## メタ情報

| 項目 | 内容 |
|------|------|
| ドキュメントID | DETAILED-ORCH-003-F101-BE |
| バージョン | 1.0.0 |
| ステータス | ドラフト |
| 作成日 | 2026-01-26 |
| 最終更新日 | 2026-01-26 |
| 作成者 | AI Assistant |
| 承認者 | - |
| 関連詳細設計書 | DETAILED-ORCH-003-F101 |
| 対象機能 | F-101 |

---

## 1. 概要

run設定デフォルト化機能のバックエンド実装仕様を定義します。

---

## 2. ファイル構成

| ファイル | 説明 | 新規/変更 |
|---------|------|----------|
| `src/core/config-merger.ts` | ConfigMergerクラス | 新規 |
| `src/core/config-merger.test.ts` | 単体テスト | 新規 |
| `src/core/types.ts` | RunConfigSchema追加 | 変更 |
| `src/core/config.ts` | ConfigMerger統合 | 変更 |
| `src/cli.ts` | ConfigMerger使用 | 変更 |

---

## 3. クラス詳細設計

### 3.1 ConfigMerger

#### ファイル: `src/core/config-merger.ts`

```typescript
import { existsSync, readFileSync } from "node:fs";
import { parse as parseYaml } from "yaml";
import { logger } from "./logger.js";
import type { RunConfig } from "./types.js";
import { RunConfigSchema } from "./types.js";

/**
 * マージオプション
 */
export interface MergeOptions {
  /**
   * CLIオプション（最優先）
   */
  cliOptions: Partial<RunConfig>;

  /**
   * 設定ファイルパス
   */
  configPath?: string;
}

/**
 * デフォルト値
 */
const DEFAULT_RUN_CONFIG: RunConfig = {
  auto_mode: false,
  create_pr: false,
  draft_pr: false,
};

/**
 * 設定統合クラス
 * 
 * CLIオプション、設定ファイル、デフォルト値を統合します。
 * 優先順位: CLIオプション > 設定ファイル > デフォルト値
 * 
 * @example
 * ```typescript
 * const merger = new ConfigMerger();
 * const config = merger.merge({
 *   cliOptions: { auto_mode: true },
 *   configPath: "orch.yml",
 * });
 * console.log(config.auto_mode); // true
 * ```
 */
export class ConfigMerger {
  /**
   * 設定を統合する
   * 
   * @param options - マージオプション
   * @returns 統合された設定
   */
  merge(options: MergeOptions): RunConfig {
    const { cliOptions, configPath } = options;

    // 1. デフォルト値
    let config: RunConfig = { ...DEFAULT_RUN_CONFIG };

    // 2. 設定ファイルの値（存在する場合）
    if (configPath) {
      const fileConfig = this.loadFileConfig(configPath);
      if (fileConfig) {
        config = { ...config, ...fileConfig };
      }
    }

    // 3. CLIオプション（最優先）
    config = this.applyCLIOptions(config, cliOptions);

    return config;
  }

  /**
   * 設定ファイルからrun設定を読み込む
   * 
   * @param configPath - 設定ファイルパス
   * @returns run設定（読み込み失敗時はnull）
   */
  private loadFileConfig(configPath: string): Partial<RunConfig> | null {
    try {
      if (!existsSync(configPath)) {
        logger.debug(`Config file not found: ${configPath}`);
        return null;
      }

      const content = readFileSync(configPath, "utf-8");
      const yaml = parseYaml(content);

      if (!yaml || typeof yaml !== "object" || !("run" in yaml)) {
        logger.debug("No 'run' section in config file");
        return null;
      }

      // zodでバリデーション
      const result = RunConfigSchema.safeParse(yaml.run);
      if (!result.success) {
        logger.warn(`Invalid run configuration: ${result.error.message}`);
        return null;
      }

      return result.data;
    } catch (error) {
      logger.warn(`Failed to load config file: ${error instanceof Error ? error.message : String(error)}`);
      return null;
    }
  }

  /**
   * CLIオプションを適用する
   * 
   * @param config - 現在の設定
   * @param cliOptions - CLIオプション
   * @returns CLIオプションが適用された設定
   */
  private applyCLIOptions(config: RunConfig, cliOptions: Partial<RunConfig>): RunConfig {
    return {
      auto_mode: cliOptions.auto_mode ?? config.auto_mode,
      create_pr: cliOptions.create_pr ?? config.create_pr,
      draft_pr: cliOptions.draft_pr ?? config.draft_pr,
    };
  }
}
```

---

## 4. メソッド詳細

### 4.1 merge

```typescript
merge(options: MergeOptions): RunConfig
```

**責務**: CLIオプション、設定ファイル、デフォルト値を統合する

**引数**:
- `options.cliOptions`: CLIオプション（部分的）
- `options.configPath`: 設定ファイルパス（オプション）

**戻り値**: 統合されたRunConfig

**処理フロー**:
1. デフォルト値をベースにする
2. 設定ファイルが存在すれば読み込み、上書き
3. CLIオプションで最終的に上書き

**エラー処理**:
- 設定ファイル読み込み失敗時は警告ログを出力し、デフォルト値を使用
- zodバリデーション失敗時も同様

### 4.2 loadFileConfig (private)

```typescript
private loadFileConfig(configPath: string): Partial<RunConfig> | null
```

**責務**: 設定ファイルからrun設定を読み込む

**引数**:
- `configPath`: 設定ファイルパス

**戻り値**: run設定（失敗時はnull）

**処理フロー**:
1. ファイル存在確認
2. YAML解析
3. `run`セクション抽出
4. zodバリデーション

**エラー処理**:
- ファイルが存在しない → nullを返す
- YAML解析失敗 → 警告ログ、nullを返す
- zodバリデーション失敗 → 警告ログ、nullを返す

### 4.3 applyCLIOptions (private)

```typescript
private applyCLIOptions(config: RunConfig, cliOptions: Partial<RunConfig>): RunConfig
```

**責務**: CLIオプションを設定に適用する

**引数**:
- `config`: 現在の設定
- `cliOptions`: CLIオプション

**戻り値**: CLIオプションが適用された設定

**処理フロー**:
- Null合体演算子（`??`）でCLIオプションが優先されるように上書き

---

## 5. 型定義

### 5.1 RunConfig

```typescript
// src/core/types.ts に追加

import { z } from "zod";

/**
 * run設定のzodスキーマ
 */
export const RunConfigSchema = z.object({
  /**
   * 承認ゲートを自動承認するか
   * @default false
   */
  auto_mode: z.boolean().default(false),

  /**
   * 完了後にPRを自動作成するか
   * @default false
   */
  create_pr: z.boolean().default(false),

  /**
   * PRをドラフトとして作成するか
   * @default false
   */
  draft_pr: z.boolean().default(false),
});

export type RunConfig = z.infer<typeof RunConfigSchema>;
```

### 5.2 MergeOptions

```typescript
export interface MergeOptions {
  cliOptions: Partial<RunConfig>;
  configPath?: string;
}
```

---

## 6. 設定スキーマ

### 6.1 orch.yml拡張

```yaml
# orch.yml

version: "1.0"

# run設定（新規）
run:
  auto_mode: true       # --auto のデフォルト
  create_pr: true       # --create-pr のデフォルト
  draft_pr: false       # --draft のデフォルト

# 既存の設定
backend:
  type: claude
  model: claude-sonnet-4-20250514

loop:
  max_iterations: 100
  completion_promise: "LOOP_COMPLETE"

# ... 他の設定
```

### 6.2 zodスキーマ統合

```typescript
// src/core/types.ts

export const ConfigSchema = z.object({
  version: z.string().default("1.0"),
  run: RunConfigSchema.optional(),  // 新規追加
  backend: BackendConfigSchema,
  loop: LoopConfigSchema,
  gates: GatesConfigSchema,
  pr: PRConfigSchema.optional(),
  state: StateConfigSchema.optional(),
  // ... 既存のスキーマ
});
```

---

## 7. テスト方針

### 7.1 単体テスト

#### ファイル: `src/core/config-merger.test.ts`

```typescript
import { describe, expect, it } from "bun:test";
import { existsSync, mkdirSync, rmSync, writeFileSync } from "node:fs";
import { ConfigMerger } from "./config-merger.js";

const TEST_DIR = ".test-config-merger";
const TEST_CONFIG_PATH = `${TEST_DIR}/orch.yml`;

describe("ConfigMerger", () => {
  beforeEach(() => {
    if (existsSync(TEST_DIR)) {
      rmSync(TEST_DIR, { recursive: true });
    }
    mkdirSync(TEST_DIR, { recursive: true });
  });

  afterEach(() => {
    if (existsSync(TEST_DIR)) {
      rmSync(TEST_DIR, { recursive: true });
    }
  });

  describe("merge", () => {
    it("should use default values when no options provided", () => {
      const merger = new ConfigMerger();
      const result = merger.merge({ cliOptions: {} });

      expect(result.auto_mode).toBe(false);
      expect(result.create_pr).toBe(false);
      expect(result.draft_pr).toBe(false);
    });

    it("should use CLI options when provided", () => {
      const merger = new ConfigMerger();
      const result = merger.merge({
        cliOptions: {
          auto_mode: true,
          create_pr: true,
        },
      });

      expect(result.auto_mode).toBe(true);
      expect(result.create_pr).toBe(true);
      expect(result.draft_pr).toBe(false); // デフォルト
    });

    it("should use file config when provided", () => {
      writeFileSync(
        TEST_CONFIG_PATH,
        `
version: "1.0"
run:
  auto_mode: true
  create_pr: false
  draft_pr: true
        `.trim()
      );

      const merger = new ConfigMerger();
      const result = merger.merge({
        cliOptions: {},
        configPath: TEST_CONFIG_PATH,
      });

      expect(result.auto_mode).toBe(true);
      expect(result.create_pr).toBe(false);
      expect(result.draft_pr).toBe(true);
    });

    it("should prioritize CLI options over file config", () => {
      writeFileSync(
        TEST_CONFIG_PATH,
        `
version: "1.0"
run:
  auto_mode: false
  create_pr: false
        `.trim()
      );

      const merger = new ConfigMerger();
      const result = merger.merge({
        cliOptions: {
          auto_mode: true,
        },
        configPath: TEST_CONFIG_PATH,
      });

      expect(result.auto_mode).toBe(true); // CLI優先
      expect(result.create_pr).toBe(false); // ファイル
      expect(result.draft_pr).toBe(false); // デフォルト
    });

    it("should handle missing config file gracefully", () => {
      const merger = new ConfigMerger();
      const result = merger.merge({
        cliOptions: {},
        configPath: "non-existent.yml",
      });

      expect(result.auto_mode).toBe(false);
      expect(result.create_pr).toBe(false);
      expect(result.draft_pr).toBe(false);
    });

    it("should handle invalid YAML gracefully", () => {
      writeFileSync(TEST_CONFIG_PATH, "invalid: yaml: content:");

      const merger = new ConfigMerger();
      const result = merger.merge({
        cliOptions: {},
        configPath: TEST_CONFIG_PATH,
      });

      expect(result.auto_mode).toBe(false);
      expect(result.create_pr).toBe(false);
      expect(result.draft_pr).toBe(false);
    });

    it("should handle missing run section gracefully", () => {
      writeFileSync(
        TEST_CONFIG_PATH,
        `
version: "1.0"
backend:
  type: claude
        `.trim()
      );

      const merger = new ConfigMerger();
      const result = merger.merge({
        cliOptions: {},
        configPath: TEST_CONFIG_PATH,
      });

      expect(result.auto_mode).toBe(false);
      expect(result.create_pr).toBe(false);
      expect(result.draft_pr).toBe(false);
    });

    it("should handle invalid run config types gracefully", () => {
      writeFileSync(
        TEST_CONFIG_PATH,
        `
version: "1.0"
run:
  auto_mode: "not a boolean"
  create_pr: 123
        `.trim()
      );

      const merger = new ConfigMerger();
      const result = merger.merge({
        cliOptions: {},
        configPath: TEST_CONFIG_PATH,
      });

      // zodバリデーション失敗 → デフォルト値
      expect(result.auto_mode).toBe(false);
      expect(result.create_pr).toBe(false);
      expect(result.draft_pr).toBe(false);
    });
  });
});
```

### 7.2 統合テスト

```typescript
// src/cli.test.ts に追加

describe("CLI with run config", () => {
  it("should use run config from file", async () => {
    writeFileSync(
      "orch.yml",
      `
version: "1.0"
run:
  auto_mode: true
  create_pr: true
      `.trim()
    );

    // CLIを実行（モック）
    const options = parseCliOptions(["run", "--issue", "42"]);
    const config = loadConfigWithMerge(options);

    expect(config.run.auto_mode).toBe(true);
    expect(config.run.create_pr).toBe(true);
  });

  it("should override file config with CLI options", async () => {
    writeFileSync(
      "orch.yml",
      `
version: "1.0"
run:
  auto_mode: false
      `.trim()
    );

    const options = parseCliOptions(["run", "--issue", "42", "--auto"]);
    const config = loadConfigWithMerge(options);

    expect(config.run.auto_mode).toBe(true); // CLI優先
  });
});
```

---

## 8. 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|----------|--------|
| 1.0.0 | 2026-01-26 | 初版作成 | AI Assistant |
