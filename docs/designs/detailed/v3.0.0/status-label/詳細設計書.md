# 詳細設計書: F-009 ステータスラベル

## メタ情報
- **ドキュメントID**: DETAIL-ORCH-004-F009-001
- **バージョン**: 1.0.0
- **ステータス**: 承認済み
- **作成日**: 2026-01-28
- **機能ID**: F-009
- **機能名**: ステータスラベル

## 1. 概要
本ドキュメントは、orchestrator-hybrid v3.0.0 におけるステータスラベル機能（F-009）の詳細設計を記述する。
この機能は、GitHub Issue にステータスラベルを自動付与することで、タスクの進行状態をリポジトリ上で可視化することを目的とする。

## 2. ステータス定義
GitHub Issue に付与されるラベルおよびその意味を以下に定義する。
ラベルの命名規則は `orch:{status}` とする（設定により接頭辞 `orch` は変更可能）。

| ステータス | ラベル名 | 色 (Hex) | 説明 |
|:---|:---|:---|:---|
| `queued` | `orch:queued` | `#c2e0c6` | 実行待ち。実行キューに入っている状態。 |
| `running` | `orch:running` | `#0e8a16` | 実行中。AIエージェントが現在処理を行っている状態。 |
| `completed` | `orch:completed` | `#0075ca` | 正常完了。AIエージェントが `LOOP_COMPLETE` を出力し、正常に終了した状態。 |
| `failed` | `orch:failed` | `#d73a4a` | 失敗。エラーが発生した、または最大反復回数に達して終了した状態。 |
| `blocked` | `orch:blocked` | `#fbca04` | ブロック中。依存関係にある Issue が完了するのを待機している状態。 |
| `pr-created` | `orch:pr-created` | `#6f42c1` | PR作成済み。処理完了後にプルリクエストが作成された状態。 |
| `merged` | `orch:merged` | `#1d76db` | マージ完了。作成されたプルリクエストがマージされた状態。 |

## 3. ステート遷移図
タスクのライフサイクルに伴うラベルの遷移を以下に示す。

```mermaid
stateDiagram-v2
    [*] --> queued
    queued --> blocked: 依存Issue未完了
    blocked --> queued: 依存Issue完了
    queued --> running: 実行開始
    running --> completed: 正常終了
    running --> failed: エラー/タイムアウト
    completed --> pr-created: --create-pr 実行
    pr-created --> merged: PRマージ検出
    failed --> queued: リトライ実行
    merged --> [*]
```

## 4. 動作ルール
- **排他的管理**: `orch:queued`, `orch:running`, `orch:completed`, `orch:failed`, `orch:blocked` は排他的に管理される。新しいラベルを付与する際、他のステータスラベルは自動的に削除される。
- **追記管理**: `orch:pr-created` および `orch:merged` は、`orch:completed` と併存、あるいは上書きされる運用とする。
- **自動作成**: 設定されたラベルが GitHub リポジトリに存在しない場合、初回の付与時に指定された色で自動作成する。
- **接頭辞カスタマイズ**: `orch.yml` の `labels.prefix` 設定により、`orch` 部分を任意に変更可能とする。

## 5. 設定 (orch.yml)
```yaml
labels:
  enabled: true        # ラベル機能を有効化
  prefix: "orch"       # ラベルの接頭辞
```

## 6. 呼び出し元（Integration Points）⚠️ 必須

> **重要**: このセクションは Phase 6.6（設計書整合性チェック）で統合漏れを検出するために必須。

### 6.1 このモジュールを使用する場所

| 呼び出し元ファイル | 使用メソッド | 説明 | 統合Issue |
|------------------|-------------|------|----------|
| `src/cli.ts` (`run` コマンド) | - | 実行開始時の `running` ラベル付与（将来実装予定） | - |
| `src/cli.ts` (`init` コマンド) | - | `--labels` オプションでラベル作成（将来実装予定） | - |
| `src/core/loop.ts` | - | ループ完了時の `completed`/`failed` ラベル付与（将来実装予定） | - |

### 6.2 統合確認コマンド

```bash
# StatusLabel の使用箇所を確認
grep -rn 'StatusLabel\|IssueStatusLabel\|setStatus' src/

# 期待される出力:
# src/output/issue-status-label-manager.ts: 実装ファイル
```

### 6.3 この機能を使用する他のIssue

| Issue | 概要 | 統合ポイント |
|-------|------|-------------|
| - | - | - |

### 6.4 統合ステータス（実装時に更新）

| 統合ポイント | ステータス | 備考 |
|-------------|----------|------|
| `run` コマンドでの `running` ラベル付与 | ❌ 未実装 | v3.0.0では未統合 |
| `init --labels` でのラベル作成 | ❌ 未実装 | オプション定義のみ |
| ループ完了時のラベル更新 | ❌ 未実装 | v3.0.0では未統合 |
| PR作成時の `pr-created` ラベル付与 | ❌ 未実装 | v3.0.0では未統合 |
