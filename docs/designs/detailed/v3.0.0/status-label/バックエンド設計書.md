# バックエンド設計書: F-009 ステータスラベル

## メタ情報
- **ドキュメントID**: DETAIL-ORCH-004-F009-BE-001
- **バージョン**: 1.0.0
- **ステータス**: 承認済み
- **作成日**: 2026-01-28
- **機能ID**: F-009
- **クラス名**: `StatusLabelManager`

## 1. クラス設計
`StatusLabelManager` は GitHub CLI (`gh`) を使用して、Issue のラベル操作を担当する。

### 1.1 プロパティ
- `prefix: string`: ラベルの接頭辞（デフォルト: `"orch"`）
- `repo: string`: 対象のリポジトリ名

### 1.2 メソッド
- `syncStatus(issueNumber: number, status: Status): Promise<void>`
  - 指定した Issue のステータスラベルを更新する。
  - 既存の他のステータスラベルを削除し、新しいラベルを付与する。
- `ensureLabelsExist(): Promise<void>`
  - リポジトリに必要なラベルが存在するか確認し、なければ作成する。
- `removeStatusLabels(issueNumber: number): Promise<void>`
  - 対象 Issue から全ての `prefix:*` ステータスラベルを削除する。

## 2. GitHub CLI コマンドの利用
ラベルの操作には `gh` コマンドを使用する。

### 2.1 ラベルの付与/削除
```bash
# ラベルの付与
gh issue edit <issue_number> --add-label "<prefix>:<status>"

# ラベルの削除
gh issue edit <issue_number> --remove-label "<prefix>:<old_status>"
```

### 2.2 ラベルの自動作成
ラベルが存在しない場合は、以下のコマンドで作成する。
```bash
gh label create "<prefix>:<status>" --color "<color_hex>" --description "Managed by orchestrator-hybrid"
```

## 3. ラベル自動作成ロジック
`ensureLabelsExist` メソッドにおいて、以下のフローでラベルを準備する。

1. `gh label list --json name` を実行し、現在のラベル一覧を取得。
2. 定義された全てのステータスラベル（`orch:queued` 等）が一覧に含まれているかチェック。
3. 含まれていないラベルについて、`gh label create` を実行。

## 4. 実装上の注意点
- **エラーハンドリング**: `gh` コマンドが失敗した場合（ネットワークエラー、権限不足等）は、ログを出力しつつ処理を継続する（ラベル更新の失敗でメインループを止めない）。
- **パフォーマンス**: 毎回 `gh label list` を呼ぶのは非効率なため、実行開始時に一度だけ `ensureLabelsExist` を呼び出す。
- **並列実行**: 複数の Issue を並列実行する場合、ラベル操作が競合しないよう、個別の Issue 番号に対してアトミックに `gh issue edit` を発行する。
