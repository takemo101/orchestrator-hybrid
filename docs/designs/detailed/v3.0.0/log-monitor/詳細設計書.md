# 詳細設計書: F-008 ログ監視

## 1. メタ情報
- **ドキュメントID**: DETAIL-ORCH-004-F008-001
- **対象機能**: F-008 ログ監視
- **バージョン**: v3.0.0
- **状態**: Draft
- **最終更新日**: 2026-01-28

## 2. 機能概要
`orch logs` コマンドは、実行中の AI エージェント（Claude Code / OpenCode）のセッション出力をリアルタイムで表示する機能である。
バックグラウンドで実行されているプロセスの進行状況を、ターミナルを切り替えることなく確認することを目的とする。

v3.0.0 では、`ISessionManager` を介してセッション出力をストリーミングすることで、`native`, `tmux`, `zellij` のどのマネージャーを使用していても統一的なインターフェースでログを閲覧可能にする。

## 3. `orch logs` コマンド仕様

### 3.1. 基本構文
```bash
orch logs [issue-number] [options]
```

### 3.2. 引数・オプション
| オプション | 短縮形 | 説明 | デフォルト |
|-----------|--------|------|-----------|
| `issue-number` | - | 表示対象の Issue 番号。省略時は最後に実行されたセッションを表示。 | (最新) |
| `--follow` | `-f` | ログをリアルタイムでストリーミング表示し続ける。 | false |
| `--lines <num>` | `-n` | 表示する最新の行数。 | 100 |

### 3.3. 動作仕様
- **Issue 番号の特定**:
  - 引数が指定された場合、対応するセッション ID（`orch-<issue>`）を特定する。
  - 省略された場合、現在実行中のセッション、または直近に終了したセッションを自動選択する。
  - 複数のセッションが実行中の場合は、選択プロンプトを表示するか、最新のものを選択する。
- **表示終了**:
  - 通常実行（`--follow` なし）の場合は、指定行数を出力して終了。
  - `--follow` 指定時は、`Ctrl+C` (SIGINT) が入力されるまで、またはセッションが終了するまで表示を継続する。

## 4. リアルタイムストリーミング（--follow）
`--follow` オプションが指定された場合、`ISessionManager.streamOutput(id)` を呼び出し、返却される `AsyncIterable<string>` を逐次 `process.stdout` に出力する。

### 4.1. 実装方針
- 内部的には `LogMonitor` クラスがストリーミングを管理する。
- ストリームの購読中にエラーが発生した場合は、適切に例外をキャッチし、エラーメッセージを表示して終了する。
- ユーザーによる中断（Ctrl+C）時は、ストリームのイテレータを適切にクローズする。

## 5. 処理フロー

```mermaid
sequenceDiagram
    participant User as ユーザー
    participant CLI as CLI (orch logs)
    participant Monitor as LogMonitor
    participant SM as ISessionManager
    participant Session as セッション (Process/Tmux)

    User->>CLI: orch logs --follow 42
    CLI->>Monitor: startMonitoring(id, follow: true)
    Monitor->>SM: streamOutput(id)
    SM-->>Monitor: AsyncIterable<string>
    
    loop リアルタイム表示
        Session->>SM: 新しい出力
        SM-->>Monitor: チャンク送信
        Monitor-->>CLI: 標準出力に表示
        CLI-->>User: ログを表示
    end

    User->>CLI: Ctrl+C (中断)
    CLI->>Monitor: stop()
    Monitor->>CLI: 終了
```

## 6. ビジネスルール
- **BR-008-1**: `--follow` 指定時は、明示的な中断（Ctrl+C）があるまで出力を継続する。
- **BR-008-2**: 対象のセッションが既に終了している場合でも、保存されているログを表示する。
- **BR-008-3**: セッションが存在しない、またはログファイルが読み取れない場合はエラーを通知する。
- **BR-008-4**: 大量のログ出力によるメモリ負荷を避けるため、ストリーミングはバッファリングせず即時出力する。
