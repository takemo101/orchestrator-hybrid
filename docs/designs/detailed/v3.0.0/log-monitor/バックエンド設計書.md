# バックエンド設計書: F-008 ログ監視

## 1. メタ情報
- **ドキュメントID**: DETAIL-ORCH-004-F008-BE-001
- **対象機能**: F-008 ログ監視（バックエンド）
- **バージョン**: v3.0.0
- **状態**: Draft
- **最終更新日**: 2026-01-28

## 2. クラス設計

### 2.1. LogMonitor クラス
`LogMonitor` は、`ISessionManager` を利用してログの取得およびストリーミングを制御する責務を持つ。

```typescript
class LogMonitor {
  constructor(private sessionManager: ISessionManager) {}

  /**
   * 特定のセッションのログを表示する
   * @param id セッションID (orch-<issue>)
   * @param options 表示オプション
   */
  async showLogs(id: string, options: LogOptions): Promise<void>;

  /**
   * リアルタイムストリーミングを開始する
   * @param id セッションID
   */
  private async stream(id: string): Promise<void>;
}

interface LogOptions {
  follow: boolean;
  lines: number;
}
```

## 3. ISessionManager.streamOutput() 連携

`LogMonitor` は、`ISessionManager` インターフェースの `streamOutput(id)` メソッドを呼び出し、非同期イテレータを購読する。

### 3.1. 連携シーケンス
1. `LogMonitor.showLogs()` が呼び出される。
2. `follow` オプションが真の場合、`sessionManager.streamOutput(id)` を実行。
3. 返却された `AsyncIterable<string>` を `for await...of` ループで回す。
4. 各チャンクを `process.stdout.write()` でターミナルに出力する。

## 4. ログ読み取り仕様

`ISessionManager` の各実装における `streamOutput()` の動作仕様は以下の通りとなる。

### 4.1. NativeSessionManager
- **実装方法**: `tail -f` 相当の動作を Bun の `fs.watch` またはポーリング、あるいは `Bun.spawn` を利用して実現。
- **読み取り対象**: `.agent/sessions/${id}/combined.log`
- **利点**: 追加の依存なしに高速なログ追従が可能。

### 4.2. TmuxSessionManager
- **実装方法**: `tmux capture-pane -p -t <session>` を一定間隔（500ms）で実行し、差分を抽出してストリームに流す。
- **差分管理**: 前回取得したテキストの最終行を保持し、次回取得時に新しい部分のみを出力する。

### 4.3. ZellijSessionManager
- **実装方法**: `zellij action dump-screen` を利用して出力をファイルにダンプし、内容を読み取る。
- **制限**: Zellij の API 制限により、Tmux よりもオーバーヘッドが大きくなる可能性があるため、間隔を調整する。

## 5. エラーハンドリングとリソース管理

- **中断処理**: 
  - `SIGINT` 受信時に `LogMonitor` はストリーミングを停止し、必要に応じてリソース（ファイルハンドル等）を解放する。
- **セッション終了検知**:
  - `ISessionManager.isRunning(id)` が `false` を返した場合、ストリーミングを終了する。
- **ログ欠損への対応**:
  - ストリーミング開始時に `lines` オプションに基づき、過去のログを `getOutput(id, lines)` で取得してからストリーミングへ移行する。
