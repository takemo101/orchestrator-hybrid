# F-011 Worktree環境分離 詳細設計書

## メタ情報

| 項目 | 内容 |
|------|------|
| ドキュメントID | DETAIL-ORCH-004-F011-001 |
| バージョン | 1.0.0 |
| 親設計書 | [基本設計書](../../../basic/BASIC-ORCH-004_v3.0.0.md) |
| 作成日 | 2026-01-28 |

---

## 1. 概要

### 1.1 機能概要

git worktreeを使用して、Issue実行ごとに完全に分離された作業環境を提供する。
これにより、複数のIssueを同時並行で実行しても互いに干渉しない。

### 1.2 設計目標

| 目標 | 詳細 |
|------|------|
| 環境分離 | 各Issueが独立したファイルシステムで動作 |
| 自動化 | worktree作成・環境ファイルコピーの自動化 |
| 安全性 | 実行中のworktree削除を防止 |

---

## 2. インターフェース定義

### 2.1 IWorktreeManager

```typescript
interface IWorktreeManager {
  /**
   * 指定されたIssue番号のworktreeを作成する
   * - ブランチ: feature/issue-{番号}
   * - パス: .worktrees/issue-{番号}/
   * - 環境ファイルをコピー
   * @throws WorktreeCreateError worktree作成に失敗した場合
   */
  create(issueNumber: number): Promise<WorktreeInfo>;

  /**
   * 全worktreeの一覧を取得する
   * git worktree list --porcelain の結果をパースして返す
   */
  list(): Promise<WorktreeInfo[]>;

  /**
   * 指定されたIssue番号のworktreeを削除する
   * - orch:running ラベルがある場合はエラー
   * - git worktree remove を実行
   * - ブランチは削除しない
   * @throws WorktreeRunningError 実行中のworktreeを削除しようとした場合
   */
  remove(issueNumber: number): Promise<void>;

  /**
   * 指定されたIssue番号のworktreeが存在するか確認する
   */
  exists(issueNumber: number): Promise<boolean>;
}

interface WorktreeInfo {
  issueNumber: number;
  branch: string;       // feature/issue-{番号}
  path: string;         // .worktrees/issue-{番号}
  status: 'running' | 'completed';
}
```

---

## 3. 処理フロー

### 3.1 Worktree作成フロー

```mermaid
flowchart TD
    START[orch run --issue 42] --> CHECK{worktree\n存在確認}
    CHECK -->|存在する| REUSE[既存worktreeを使用]
    CHECK -->|存在しない| CREATE[worktree作成]
    CREATE --> BRANCH[ブランチ作成\nfeature/issue-42]
    BRANCH --> WORKTREE[git worktree add\n.worktrees/issue-42]
    WORKTREE --> COPY[環境ファイルコピー\n.env, .envrc]
    COPY --> READY[実行準備完了]
    REUSE --> READY
    READY --> EXEC[worktree内で実行]
```

### 3.2 Worktree削除フロー

```mermaid
flowchart TD
    START[orch worktree remove 42] --> LABEL{orch:running\nラベル確認}
    LABEL -->|ラベルあり| ERROR[エラー:\n実行中は削除不可]
    LABEL -->|ラベルなし| REMOVE[git worktree remove\n.worktrees/issue-42]
    REMOVE --> PRUNE[git worktree prune]
    PRUNE --> DONE[削除完了]
```

---

## 4. ビジネスルール

| ルールID | ルール | 詳細 |
|---------|--------|------|
| BR-011-1 | worktreeパス | `.worktrees/issue-{番号}/` に作成 |
| BR-011-2 | ブランチ命名 | `feature/issue-{番号}` |
| BR-011-3 | 環境ファイルコピー | 設定 `worktree.copy_files` に指定されたファイルを自動コピー |
| BR-011-4 | クリーンアップ | 手動 (`orch worktree remove`) |
| BR-011-5 | 削除保護 | `orch:running` ラベルがあるIssueのworktreeは削除不可 |

---

## 5. 環境ファイル管理

### 5.1 コピー対象

設定ファイル `orch.yml` の `worktree.copy_files` で指定:

```yaml
worktree:
  copy_files:
    - ".env"
    - ".envrc"
```

### 5.2 コピーロジック

```typescript
async function copyEnvironmentFiles(
  sourceDir: string,
  targetDir: string,
  files: string[]
): Promise<void> {
  for (const file of files) {
    const src = path.join(sourceDir, file);
    const dst = path.join(targetDir, file);
    
    // ファイルが存在する場合のみコピー
    if (await Bun.file(src).exists()) {
      await Bun.write(dst, Bun.file(src));
    }
  }
}
```

### 5.3 .gitignore連携

worktreeディレクトリ自体は `.gitignore` に追加する:

```gitignore
.worktrees/
```

---

## 6. CLIコマンド仕様

### 6.1 orch worktrees

**概要**: worktree一覧表示

**出力フォーマット**:

| カラム | 説明 | ソース |
|--------|------|--------|
| Issue | Issue番号 | パスから抽出 |
| Branch | ブランチ名 | git worktree list |
| Path | ファイルパス | git worktree list |
| Status | 実行状態 | GitHub Issueラベル |

### 6.2 orch worktree remove

**概要**: worktree削除

**引数**: Issue番号（必須）

**処理**:
1. `gh issue view {番号}` でラベル確認
2. `orch:running` ラベルがある場合はエラー出力して終了
3. `git worktree remove .worktrees/issue-{番号}` 実行
4. `git worktree prune` 実行

### 6.3 --no-worktree オプション

`orch run --issue 42 --no-worktree` でworktree作成をスキップし、現在のディレクトリで直接実行する。

---

## 7. エラーハンドリング

| エラー | 原因 | 対応 |
|--------|------|------|
| `WorktreeCreateError` | git worktree add 失敗 | エラーメッセージ表示、gitの出力を含める |
| `WorktreeRunningError` | 実行中のworktree削除試行 | 「Issue #{番号} は実行中です」と表示 |
| `WorktreeNotFoundError` | 存在しないworktree削除試行 | 「Worktree issue-{番号} が見つかりません」と表示 |
| `BranchExistsError` | ブランチが既に存在 | 既存ブランチを使用してworktree作成 |
| `CopyFileError` | 環境ファイルコピー失敗 | 警告を表示して続行 |

---

## 8. 呼び出し元（Integration Points）⚠️ 必須

> **重要**: このセクションは Phase 6.6（設計書整合性チェック）で統合漏れを検出するために必須。

### 8.1 このモジュールを使用する場所

| 呼び出し元ファイル | 使用方法 | 統合Issue |
|------------------|---------|----------|
| `src/cli.ts` | `run` コマンドで `WorktreeManager.create()` を呼び出す | #127, #143 |
| `src/cli.ts` | `worktrees` コマンドで `WorktreeManager.list()` を呼び出す | #127 |
| `src/cli.ts` | `worktree remove` コマンドで `WorktreeManager.remove()` を呼び出す | #127 |
| `src/core/loop.ts` | `LoopEngine` が worktree パスを作業ディレクトリとして使用 | #143 |

### 8.2 統合確認コマンド

```bash
# 1. WorktreeManager が CLI から import されているか確認
grep -r 'WorktreeManager\|worktree' src/cli.ts

# 2. run コマンドで worktree 作成が呼ばれているか確認
grep -A 20 'command.*run' src/cli.ts | grep -i worktree

# 3. worktrees コマンドが存在するか確認
grep -A 10 'command.*worktrees' src/cli.ts

# 4. worktree remove コマンドが存在するか確認
grep -A 10 'command.*worktree.*remove' src/cli.ts

# 5. CLIコマンド動作確認
./orch worktrees
./orch run --issue 999 --dry-run  # worktree作成のdry-run（実装されている場合）
```

### 8.3 この機能を使用する他のIssue

| Issue | 概要 | 統合ポイント |
|-------|------|-------------|
| #127 | CLI統合 | CLIコマンドの登録 |
| #143 | CLI配線 | run コマンドからの呼び出し |
| #125 | セッション管理 | セッション実行時の作業ディレクトリとして使用 |

### 8.4 統合ステータス（実装時に更新）

| 統合ポイント | ステータス | 備考 |
|-------------|----------|------|
| `orch run` での worktree 自動作成 | ❌ 未実装 | CLI で WorktreeManager を呼び出すコードがない |
| `orch worktrees` コマンド | ❌ 未実装 | プレースホルダーのみ |
| `orch worktree remove` コマンド | ❌ 未実装 | プレースホルダーのみ |
| LoopEngine での worktree パス使用 | ❌ 未実装 | 作業ディレクトリとして渡されていない |

> **Note**: 上記の未実装項目が全て完了するまで、この機能は「統合完了」とみなさない。

---

## 9. テスト方針

### 9.1 単体テスト

| テストケース | 内容 |
|------------|------|
| worktree作成 | gitコマンドが正しい引数で呼ばれるか |
| 環境ファイルコピー | 指定ファイルがコピーされるか |
| 一覧取得 | git worktree list の出力が正しくパースされるか |
| 削除保護 | running状態のworktreeが削除できないか |
| 削除成功 | 完了状態のworktreeが削除できるか |

### 9.2 結合テスト

| テストケース | 内容 |
|------------|------|
| E2E作成→実行→削除 | worktree作成からAI実行、削除までの全フロー |
| 並列実行 | 複数worktreeが同時に動作するか |
| --no-worktree | worktreeなしでの実行が正常に動作するか |

---

## 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|----------|--------|
| 1.0.0 | 2026-01-28 | 初版作成 | AI Assistant |
