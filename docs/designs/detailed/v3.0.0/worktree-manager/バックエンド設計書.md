# F-011 Worktree環境分離 バックエンド設計書

## メタ情報

| 項目 | 内容 |
|------|------|
| ドキュメントID | DETAIL-ORCH-004-F011-BE-001 |
| バージョン | 1.0.0 |
| 親設計書 | [詳細設計書](./詳細設計書.md) |
| 作成日 | 2026-01-28 |

---

## 1. 概要

WorktreeManagerクラスの実装詳細を定義する。
git worktreeコマンドのラッパーとして、Issue単位の環境分離を実現する。

---

## 2. クラス設計

### 2.1 WorktreeManager

```typescript
import { exec } from '../core/exec';
import type { Config } from '../core/types';

export class WorktreeManager implements IWorktreeManager {
  private config: Config;
  private baseDir: string;

  constructor(config: Config) {
    this.config = config;
    this.baseDir = config.worktree?.base_dir ?? '.worktrees';
  }

  async create(issueNumber: number): Promise<WorktreeInfo> {
    const branch = `feature/issue-${issueNumber}`;
    const worktreePath = `${this.baseDir}/issue-${issueNumber}`;

    // 既存チェック
    if (await this.exists(issueNumber)) {
      return this.getWorktreeInfo(issueNumber);
    }

    // ブランチ存在チェック
    const branchExists = await this.branchExists(branch);

    if (branchExists) {
      // 既存ブランチでworktree作成
      await exec('git', ['worktree', 'add', worktreePath, branch]);
    } else {
      // 新規ブランチでworktree作成
      await exec('git', ['worktree', 'add', '-b', branch, worktreePath, 'main']);
    }

    // 環境ファイルコピー
    await this.copyEnvironmentFiles(worktreePath);

    return {
      issueNumber,
      branch,
      path: worktreePath,
      status: 'running',
    };
  }

  async list(): Promise<WorktreeInfo[]> {
    const result = await exec('git', ['worktree', 'list', '--porcelain']);
    return this.parseWorktreeList(result.stdout);
  }

  async remove(issueNumber: number): Promise<void> {
    // 実行中チェック
    const isRunning = await this.isIssueRunning(issueNumber);
    if (isRunning) {
      throw new WorktreeRunningError(issueNumber);
    }

    const worktreePath = `${this.baseDir}/issue-${issueNumber}`;
    
    // worktree削除
    await exec('git', ['worktree', 'remove', worktreePath, '--force']);
    
    // プルーニング
    await exec('git', ['worktree', 'prune']);
  }

  async exists(issueNumber: number): Promise<boolean> {
    const worktreePath = `${this.baseDir}/issue-${issueNumber}`;
    const list = await this.list();
    return list.some(wt => wt.path.endsWith(`issue-${issueNumber}`));
  }

  // --- Private methods ---

  private async branchExists(branch: string): Promise<boolean> {
    try {
      await exec('git', ['rev-parse', '--verify', branch]);
      return true;
    } catch {
      return false;
    }
  }

  private async copyEnvironmentFiles(targetDir: string): Promise<void> {
    const files = this.config.worktree?.copy_files ?? ['.env'];
    for (const file of files) {
      try {
        const src = Bun.file(file);
        if (await src.exists()) {
          await Bun.write(`${targetDir}/${file}`, src);
        }
      } catch (error) {
        // コピー失敗は警告のみ（続行可能）
        console.warn(`Warning: Failed to copy ${file}: ${error}`);
      }
    }
  }

  private async isIssueRunning(issueNumber: number): Promise<boolean> {
    try {
      const result = await exec('gh', [
        'issue', 'view', String(issueNumber),
        '--json', 'labels',
        '--jq', '.labels[].name'
      ]);
      return result.stdout.includes('orch:running');
    } catch {
      return false;
    }
  }

  private parseWorktreeList(output: string): WorktreeInfo[] {
    const worktrees: WorktreeInfo[] = [];
    const blocks = output.split('\n\n').filter(Boolean);

    for (const block of blocks) {
      const lines = block.split('\n');
      const pathLine = lines.find(l => l.startsWith('worktree '));
      const branchLine = lines.find(l => l.startsWith('branch '));

      if (!pathLine || !branchLine) continue;

      const path = pathLine.replace('worktree ', '');
      const branch = branchLine.replace('branch refs/heads/', '');

      // .worktrees/issue-XX パターンにマッチするもののみ
      const match = path.match(/issue-(\d+)$/);
      if (!match) continue;

      worktrees.push({
        issueNumber: parseInt(match[1], 10),
        branch,
        path,
        status: 'completed', // デフォルト。実際のステータスはラベルで確認
      });
    }

    return worktrees;
  }
}
```

---

## 3. gitコマンド詳細

### 3.1 worktree作成

```bash
# 新規ブランチで作成
git worktree add -b feature/issue-42 .worktrees/issue-42 main

# 既存ブランチで作成
git worktree add .worktrees/issue-42 feature/issue-42
```

### 3.2 worktree一覧

```bash
git worktree list --porcelain

# 出力例:
# worktree /path/to/repo
# HEAD abc123def456
# branch refs/heads/main
#
# worktree /path/to/repo/.worktrees/issue-42
# HEAD def456abc123
# branch refs/heads/feature/issue-42
```

### 3.3 worktree削除

```bash
# 削除
git worktree remove .worktrees/issue-42 --force

# クリーンアップ
git worktree prune
```

---

## 4. GitHub API連携

### 4.1 ラベル確認（削除保護）

```bash
# Issue のラベルを取得
gh issue view 42 --json labels --jq '.labels[].name'

# 出力例:
# enhancement
# orch:running
```

### 4.2 ステータス連携

WorktreeManager は直接ラベルを操作しない。
ラベル管理は StatusLabelManager (F-009) が担当する。

WorktreeManager は以下の場合のみラベルを**読み取り**参照する:
- `remove()`: `orch:running` ラベルの有無をチェック

---

## 5. ディレクトリ構造

### 5.1 worktree内の構造

worktree内はメインリポジトリの完全なコピーとなる:

| パス | 説明 |
|------|------|
| `.worktrees/issue-{番号}/src/` | ソースコード（gitが管理） |
| `.worktrees/issue-{番号}/.env` | 環境変数（コピー） |
| `.worktrees/issue-{番号}/.envrc` | direnv設定（コピー） |
| `.worktrees/issue-{番号}/.agent/PROMPT.md` | 生成されたプロンプト |

### 5.2 .gitignore

メインリポジトリの `.gitignore` に追加:

```
.worktrees/
```

---

## 6. エラークラス

```typescript
export class WorktreeCreateError extends Error {
  constructor(issueNumber: number, cause: Error) {
    super(`Failed to create worktree for issue #${issueNumber}: ${cause.message}`);
    this.name = 'WorktreeCreateError';
    this.cause = cause;
  }
}

export class WorktreeRunningError extends Error {
  constructor(issueNumber: number) {
    super(`Cannot remove worktree: issue #${issueNumber} is currently running`);
    this.name = 'WorktreeRunningError';
  }
}

export class WorktreeNotFoundError extends Error {
  constructor(issueNumber: number) {
    super(`Worktree for issue #${issueNumber} not found`);
    this.name = 'WorktreeNotFoundError';
  }
}
```

---

## 7. テスト方針

### 7.1 モック戦略

| 依存 | モック方法 |
|------|----------|
| `git` コマンド | `exec` 関数をモック |
| `gh` コマンド | `exec` 関数をモック |
| ファイルシステム | Bun.file / Bun.write をモック |

### 7.2 テストケース

| テスト | 入力 | 期待結果 |
|--------|------|---------|
| 新規作成 | `create(42)` | `git worktree add -b feature/issue-42 ...` が呼ばれる |
| 既存ブランチ | `create(42)` (ブランチ存在) | `-b` なしで `git worktree add` が呼ばれる |
| 一覧取得 | `list()` | porcelain出力が正しくパースされる |
| 削除（成功） | `remove(42)` (running以外) | `git worktree remove` が呼ばれる |
| 削除（拒否） | `remove(42)` (running) | `WorktreeRunningError` がスローされる |
| 存在確認 | `exists(42)` | boolean が返る |
| 環境ファイルコピー | `.env`存在 | worktreeにコピーされる |
| 環境ファイル欠落 | `.env`なし | エラーにならず続行 |

---

## 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|----------|--------|
| 1.0.0 | 2026-01-28 | 初版作成 | AI Assistant |
