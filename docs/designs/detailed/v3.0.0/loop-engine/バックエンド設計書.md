# バックエンド設計書: F-003 ループ実行

## 1. メタ情報
- **ドキュメントID**: DETAIL-ORCH-004-F003-BE-001
- **対象機能**: F-003 ループ実行（バックエンド実装）
- **バージョン**: v3.0.0
- **状態**: Draft
- **最終更新日**: 2026-01-28

## 2. クラス設計

### 2.1. LoopEngine クラス
ループ実行のライフサイクルを管理する主要クラス。

```typescript
class LoopEngine {
  constructor(
    private readonly backend: IBackend,
    private readonly sessionManager: ISessionManager,
    private readonly config: Config
  ) {}

  /**
   * ループ実行を開始する
   */
  async run(issue: Issue, options: LoopOptions): Promise<LoopResult> {
    // 1. コンテキスト初期化
    // 2. 反復ループ開始
    // 3. セッション作成と監視
    // 4. 完了判定と結果返却
  }
}
```

## 3. インターフェース連携

### 3.1. IBackend との連携
`IBackend` は AI エージェントの実行コマンド（`claude`, `opencode` 等）のメタデータを保持する。

- `LoopEngine` は `IBackend.getCommand()` および `getArgs()` を使用して、`ISessionManager` に渡す起動情報を取得する。
- バックエンド固有のプロンプト挿入ロジックは `IBackend` 内で完結させる。

### 3.2. ISessionManager との連携
実行環境（Native, Tmux, Zellij）の差分を吸収する。

- **セッション作成**: `sessionManager.create(id, command, args)` を呼び出し、バックエンドプロセスを開始。
- **出力取得**: `sessionManager.getOutput(id)` を定期的にポーリング、または `streamOutput(id)` による非同期イテレーションで出力をスキャン。
- **生存確認**: `sessionManager.isRunning(id)` でプロセスのクラッシュを検知。
- **強制終了**: 最大反復回数超過やエラー時に `sessionManager.kill(id)` を実行。

### 3.3. ISessionManager 実装の使い分け
- `NativeSessionManager`: サーバー等のバックグラウンド実行に適した、直接プロセスを起動するデフォルト実装。
- `TmuxSessionManager` / `ZellijSessionManager`: ユーザーがターミナルから直接介入したり、実行中の様子を「Attach」して確認したりする場合に使用。

## 4. データ構造

### 4.1. LoopContext
ループ実行中の状態を保持する。

| フィールド | 型 | 説明 |
|---|-|---|
| `iteration` | `number` | 現在の反復回数 |
| `maxIterations` | `number` | 最大許容回数 |
| `startTime` | `Date` | 実行開始時刻 |
| `currentSessionId` | `string` | 現在実行中のセッションID |

## 5. 処理の詳細フロー

1. **初期化**: プロンプトファイルを読み込み、`LoopContext` を生成。
2. **ループ開始**:
   - `sessionManager.create()` で AI エージェントを起動。
   - `sessionManager.streamOutput()` を使用して、チャンクごとに出力をバッファに蓄積。
   - 蓄積されたバッファ内に `LOOP_COMPLETE` が含まれているか毎秒チェック。
3. **終了処理**:
   - キーワード検出時: セッションを正常終了させ、成功フラグを立てる。
   - プロセス終了時（キーワードなし）: イテレーションを終了し、次へ進む。
   - 例外発生時: エラー内容をログに記録し、クリーンアップを行う。
