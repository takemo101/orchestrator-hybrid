# F-004 PR作成 詳細設計書

## メタ情報
| 項目 | 内容 |
|------|------|
| ドキュメントID | DETAIL-ORCH-004-F004-001 |
| バージョン | 1.0.0 |
| ステータス | ドラフト |
| 作成日 | 2026-01-28 |
| 対応機能ID | F-004 |
| 作成者 | AI Assistant |

## 1. 機能概要
`F-004: PR作成`は、AIによるタスク実行ループ（F-003）が正常に完了した後、生成されたコード変更をGitHubのプルリクエストとして自動的に作成する機能である。本機能により、開発者はAIによる変更内容をブラウザで即座に確認し、レビュープロセスに移行することができる。

## 2. 処理フロー
```mermaid
sequenceDiagram
    participant Loop as Loop Engine
    participant PR as PR Creator
    participant Git as Git CLI
    participant GH as GitHub CLI (gh)

    Loop->>PR: 作成依頼 (Issue番号, ブランチ名)
    PR->>Git: 変更の有無を確認
    Git-->>PR: 変更あり
    PR->>Git: コミット作成 (git commit -m "...")
    PR->>Git: リモートへプッシュ (git push -u origin ...)
    PR->>PR: PRタイトル・本文の生成
    PR->>GH: PR作成 (gh pr create)
    GH-->>PR: PR URL返却
    PR-->>Loop: 完了報告 (PR URL)
```

## 3. PRテンプレート仕様
PRのタイトルと本文は、実行対象のIssue情報を基に以下の形式で生成される。

### 3.1 タイトル
`feat: [Issueタイトル] (resolve #Issue番号)`

### 3.2 本文
```markdown
## 概要
Issue #Issue番号 に基づく自動実装。

## 変更内容
- AIエージェントによる自動生成コードの反映

## 関連Issue
Closes #Issue番号
```

## 4. Issue連携
PRの本文に `Closes #<Issue番号>` を含めることで、PRがマージされた際に自動的に対象のGitHub Issueがクローズされるように制御する。

## 5. エラーハンドリング
| エラーケース | 対応方針 |
|------------|----------|
| 変更ファイルがない | PR作成をスキップし、その旨をログ出力する（正常終了扱い） |
| `gh`コマンド未認証 | エラーを表示し、マニュアルでのPR作成を促す |
| 同名のブランチがリモートに存在 | 強制プッシュせず、既存ブランチへの追加コミットとして処理を試みる |
| ネットワークエラー | リトライは行わず、エラー終了とする |
