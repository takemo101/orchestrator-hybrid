# F-010 Issue依存関係 バックエンド設計書

## メタ情報
- **ドキュメントID**: DETAIL-ORCH-004-F010-BE-001
- **機能ID**: F-010
- **バージョン**: 1.0.0
- **ステータス**: ドラフト
- **作成日**: 2026-01-28
- **作成者**: Antigravity (AI Technical Writer)

---

## 1. クラス設計

### 1.1 DependencyResolver クラス
Issueの依存関係を解析し、最適な実行順序を決定するコアコンポーネント。

#### プロパティ
- `issueFetcher: IIssueFetcher`: Issue情報を取得するためのフェッチャー。
- `executor: ProcessExecutor`: `gh` コマンドを実行するためのエグゼキューター。

#### 主要メソッド
- `resolveOrder(rootIssueId: number): Promise<number[]>`
    - 指定されたIssueを起点に依存ツリーを構築し、トポロジカルソートされた実行順序リストを返す。
- `parseDependencies(body: string): number[]`
    - Issue本文から依存Issue IDを抽出する（詳細は 2. 参照）。
- `buildGraph(rootId: number, visited: Map<number, DependencyNode>): Promise<void>`
    - 再帰的にIssue情報を取得し、依存グラフを構築する。

---

## 2. 依存関係抽出パーサー

Issue本文から依存関係を抽出するための正規表現ベースのパーサーを実装する。

### 2.1 抽出ロジック
以下のキーワードに続く `#` + `数字` を抽出対象とする。

- **正規表現**: `/(?:Blocked by|Depends on|Needs|前提Issue)[:\s]*#(\d+)/gi`
- **対象例**:
    - `Blocked by #42`
    - `Depends on #43, #44`
    - `前提Issue: #45`

### 2.2 実装コードイメージ (TypeScript)
```typescript
class DependencyParser {
  static extractIds(body: string): number[] {
    const regex = /(?:Blocked by|Depends on|Needs|前提Issue)[:\s]*#(\d+)/gi;
    const matches = body.matchAll(regex);
    const ids = new Set<number>();
    for (const match of matches) {
      ids.add(parseInt(match[1], 10));
    }
    return Array.from(ids);
  }
}
```

---

## 3. 再帰的実行ロジック

### 3.1 処理アルゴリズム
1. **グラフ構築**: 
   - ターゲットIssueを取得し、本文から依存IDを抽出。
   - 抽出された各IDについて再帰的にIssueを取得し、依存関係がなくなるまで繰り返す。
2. **循環参照チェック**:
   - DFS（深さ優先探索）を行い、訪問中のノードに再度到達した場合は `CircularDependencyError` をスローする。
3. **トポロジカルソート**:
   - 入次数（in-degree）を用いたKahn'sアルゴリズムまたはDFSの帰りがけ順を用いて順序を決定する。
4. **フィルタリング**:
   - すでに完了状態（`state: "closed"` または特定ラベル付与済み）のIssueは、実行リストから除外する（または実行時にスキップ判定を行う）。

---

## 4. データ構造定義

```typescript
export interface DependencyNode {
  issueNumber: number;
  dependencies: number[]; // このIssueが依存している（先に終わらせるべき）ID
  state: 'open' | 'closed';
}

export interface ResolveOptions {
  includeCompleted: boolean; // 完了済みも含めるか（デフォルト: false）
}
```

---

## 5. 異常系ハンドリング

- **GitHub API 制限**: `gh` コマンド実行時にリトライロジックを検討する。
- **無効なIssue番号**: 存在しないIssue IDが抽出された場合、ログに警告を出力し、そのブランチの解析をスキップする。
- **深いネスト**: 依存関係の深さに上限（例: 20層）を設け、意図しない無限ループを防止する。
