# プリセット バックエンド設計書

## メタ情報

| 項目 | 内容 |
|------|------|
| ドキュメントID | DETAIL-ORCH-004-F007-BE-001 |
| バージョン | 1.0.0 |
| ステータス | ドラフト |
| 作成日 | 2026-01-28 |
| 対象機能 | F-007: プリセット |

---

## 1. クラス設計

### 1.1 PresetLoader クラス

プリセットファイルの読み込みとマージを担当するクラス。

- **役割**:
  - `presets/` ディレクトリから指定されたプリセットファイルを検索。
  - YAML 形式の定義を読み込み、Zod スキーマで検証。
  - 現在のユーザー設定とプリセット定義をマージし、最終的な実行コンテキストを生成。

- **主要メソッド**:
  - `load(presetName: string): Promise<Config>`: 指定されたプリセットを読み込む。
  - `listPresets(): Promise<string[]>`: 利用可能なプリセット名の一覧を返す。
  - `merge(userConfig: Config, presetConfig: Config): Config`: 設定のマージを行う。

---

## 2. プリセット YAML スキーマ

プリセットファイルは `ConfigSchema` の一部を定義する。

```yaml
# 例: tdd.yml
loop:
  completion_promise: "LOOP_COMPLETE"

hats:
  tester:
    triggers: ["task.start", "code.written"]
    publishes: ["tests.failing", "tests.passing"]
    instructions: |
      ... (詳細な指示) ...

  implementer:
    triggers: ["tests.failing"]
    publishes: ["code.written"]
    instructions: |
      ... (詳細な指示) ...

  refactorer:
    triggers: ["tests.passing"]
    publishes: ["LOOP_COMPLETE"]
    instructions: |
      ... (詳細な指示) ...
```

- **検証**: 既存の `src/core/types.ts` で定義されている `ConfigSchema` を再利用して検証を行う。
- **制限**: プリセットでは `backend` などの環境依存設定は含めず、主に `loop` や `hats` のロジックを定義する。

---

## 3. 設定マージロジック

設定の優先順位は以下の通りとなる（上ほど優先度が高い）。

1. **CLI オプション**（`--max-iterations` など）
2. **ユーザー設定ファイル** (`orch.yml`)
3. **プリセット定義** (`presets/*.yml`)
4. **デフォルト値**

### マージルール

- **プリミティブ値** (string, number, boolean):
  - ユーザー設定に値がある場合はそれを優先し、なければプリセットの値を使用する。
- **配列**:
  - 原則としてユーザー設定で上書きする（マージ・結合は行わない）。
- **オブジェクト** (hats 等):
  - キー単位でマージを行う。
  - ユーザーが `orch.yml` で特定の Hat を定義している場合、プリセットの同名 Hat はユーザー定義で完全に上書きされる。

---

## 4. 処理フロー

1. CLI 解析によりプリセット名を取得。
2. `PresetLoader` が `presets/<name>.yml` を探索。
3. ファイルが存在しない場合はエラーをスロー。
4. ファイルが存在する場合、YAML をパースし `ConfigSchema` で検証。
5. デフォルト設定、プリセット設定、ユーザー設定、CLI オプションの順でマージを実行。
6. マージ後の `Config` オブジェクトを `Loop` エンジンに渡す。
