# プリセット 詳細設計書

## メタ情報

| 項目 | 内容 |
|------|------|
| ドキュメントID | DETAIL-ORCH-004-F007-001 |
| バージョン | 1.0.0 |
| ステータス | ドラフト |
| 作成日 | 2026-01-28 |
| 対象機能 | F-007: プリセット |

---

## 1. 機能概要

プリセットは、orchestrator-hybrid における一般的なワークフロー（ループ構成やHat定義）を定義済みの設定セットとして提供する機能である。ユーザーは個別のプロジェクトで複雑なHat設定を記述することなく、`--preset` オプションを指定するだけで高度な開発フローを利用できる。

v3.0.0では、シンプル化の方針に基づき、最も利用頻度の高い「simple」と「tdd」の2種類に絞り込んで提供する。

---

## 2. プリセット一覧

| プリセット名 | 説明 | 主要な構成 |
|--------------|------|------------|
| **simple**   | Hatを使用しない単純な反復ループ | Hatなし |
| **tdd**      | テスト駆動開発（Red → Green → Refactor）を強制するワークフロー | Tester, Implementer, Refactorer |

---

## 3. プリセット仕様

### 3.1 simple プリセット

単純なループ実行を行うための最小構成プリセット。

- **Hat構成**: なし
- **完了条件**: AIバックエンドが `LOOP_COMPLETE` を出力した時点で終了
- **用途**:
  - 単発のスクリプト作成
  - バグ調査
  - 自由度の高い対話型開発
- **動作フロー**:
  1. Issue取得・プロンプト生成
  2. ループ開始
  3. AIバックエンド実行（Hatによる指示追加なし）
  4. 出力に `LOOP_COMPLETE` が含まれるか確認
  5. 含まれれば終了、含まれなければイテレーション継続

### 3.2 tdd プリセット

テスト駆動開発のサイクルを Hat システムで制御するプリセット。

- **Hat構成**:
  - **Tester**: テストの作成・実行を担当
  - **Implementer**: 実装コードの記述を担当
  - **Refactorer**: コードの最適化を担当
- **ワークフロー**:
  1. **Tester**: `task.start`（開始時）または `code.written`（実装後）にトリガーされ、テストを記述または実行する。
     - テスト失敗時: `tests.failing` を発行
     - テスト通過時: `tests.passing` を発行
  2. **Implementer**: `tests.failing` にトリガーされ、テストを通過させるための最小限の実装を行う。
     - 完了時: `code.written` を発行
  3. **Refactorer**: `tests.passing` にトリガーされ、実装のクリーンアップを行う。
     - 完了時: `LOOP_COMPLETE` を発行して終了

---

## 4. プリセットファイル構造

プリセットの定義は、プロジェクトルートの `presets/` ディレクトリ内に YAML 形式で配置される。

- `presets/simple.yml` - simpleプリセット定義
- `presets/tdd.yml` - tddプリセット定義

ユーザーが CLI で `--preset <name>` を指定すると、`presets/<name>.yml` が読み込まれ、現在の設定（`orch.yml`）とマージされる。

## 5. 呼び出し元（Integration Points）⚠️ 必須

> **重要**: このセクションは Phase 6.6（設計書整合性チェック）で統合漏れを検出するために必須。

### 5.1 このモジュールを使用する場所

| 呼び出し元ファイル | 使用メソッド | 説明 | 統合Issue |
|------------------|-------------|------|----------|
| `src/cli.ts` (`run` コマンド) | - | `--preset` オプション経由で設定マージ（将来実装予定） | - |
| `src/cli.ts` (`init` コマンド) | - | `--preset` オプション経由で初期化（将来実装予定） | - |
| `src/core/config.ts` | - | プリセット読み込み・マージロジック（将来実装予定） | - |

### 5.2 統合確認コマンド

```bash
# Preset の使用箇所を確認
grep -rn 'preset\|Preset' src/

# 期待される出力:
# src/cli.ts: --preset オプション定義
# presets/: プリセット定義ファイル群
```

### 5.3 この機能を使用する他のIssue

| Issue | 概要 | 統合ポイント |
|-------|------|-------------|
| - | - | - |

### 5.4 統合ステータス（実装時に更新）

| 統合ポイント | ステータス | 備考 |
|-------------|----------|------|
| `run` コマンドでのプリセット適用 | ❌ 未実装 | オプション定義のみ、実処理は未統合 |
| `init` コマンドでのプリセット初期化 | ❌ 未実装 | オプション定義のみ、実処理は未統合 |
| 設定ファイルマージロジック | ❌ 未実装 | presets/ ディレクトリ未作成 |
