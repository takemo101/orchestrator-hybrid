# Hatシステム バックエンド設計書 (v3.0.0)

## メタ情報
- **ドキュメントID**: DETAIL-ORCH-004-F006-BE-001
- **対象機能**: F-006 Hatシステム (Backend Implementation)
- **ステータス**: Draft
- **最終更新日**: 2026-01-28
- **技術スタック**: Bun + TypeScript

## 1. クラス設計

### 1.1 EventBus クラス
システム内でのイベント配送を担当するシングルトンまたはコンテキスト共有クラス。

```typescript
/**
 * イベント情報を保持するインターフェース
 */
interface OrchEvent {
  topic: string;
  message?: string;
  timestamp: Date;
}

/**
 * イベントバス
 * トピックベースの購読と発行を管理する
 */
class EventBus {
  private history: OrchEvent[] = [];

  /**
   * イベントを発行する
   */
  emit(topic: string, message?: string): void {
    const event: OrchEvent = {
      topic,
      message,
      timestamp: new Date()
    };
    this.history.push(event);
    // ログへの出力等の副作用
  }

  /**
   * 最新のイベントを取得する
   */
  getLatestEvent(): OrchEvent | null {
    return this.history.length > 0 ? this.history[this.history.length - 1] : null;
  }

  /**
   * 履歴をクリアする
   */
  clearHistory(): void {
    this.history = [];
  }
}
```

### 1.2 HatSystem クラス
Hatの定義を管理し、現在の状態に最適なHatを選択する。

```typescript
import { HatDefinition } from './types';

class HatSystem {
  private hats: Map<string, HatDefinition> = new Map();

  constructor(definitions: Record<string, HatDefinition>) {
    for (const [id, def] of Object.entries(definitions)) {
      this.hats.set(id, def);
    }
  }

  /**
   * トピックに一致するHatを検索する
   * 複数一致した場合は、最初に見つかったものを返す
   */
  findHatByTrigger(topic: string): HatDefinition | null {
    for (const hat of this.hats.values()) {
      if (hat.triggers.includes(topic)) {
        return hat;
      }
    }
    return null;
  }

  /**
   * 全てのHat定義を取得する
   */
  getAllHats(): HatDefinition[] {
    return Array.from(this.hats.values());
  }
}
```

## 2. Hat切り替えロジック

ループエンジン（`LoopEngine`）におけるHat適用の流れは以下の通り。

1. **初期状態**: 
   - `task.start` イベントを発行してループを開始する。
2. **Hatの選択**:
   - `EventBus` から最新のイベントトピックを取得。
   - `HatSystem.findHatByTrigger(topic)` を呼び出し、対応するHatを取得。
3. **プロンプトへの統合**:
   - Hatが見つかった場合、その `instructions` をプロンプトの「現在の役割」セクションに挿入する。
   - 見つからない場合は、デフォルトの指示（Generalist）を使用する。
4. **イベントの連鎖**:
   - AIの実行結果から `EVENT: topic` をパース。
   - パースされたトピックで `EventBus.emit()` を実行。
   - 次のイテレーションでステップ2に戻る。

## 3. 実装上の注意点

- **無限ループの防止**: 同一のイベントトピックが連続して発行され、状態が変化していない場合に最大反復回数（`max_iterations`）で停止するようにループエンジン側で制御する。
- **指示の競合**: Hatの `instructions` は基本プロンプトの後に「追加の制約」として結合する。指示が矛盾しないよう、基本プロンプトは最小限のタスク定義に留めることが望ましい。
- **データ永続化**: 実行中のイベント履歴は `.agent/events.jsonl` に保存し、中断後の再開時に状態を復元できるようにする。
