# 詳細設計書: F-012 セッション管理

## 1. メタ情報
- **ドキュメントID**: DETAIL-ORCH-004-F012-001
- **対象機能**: F-012 セッション管理
- **バージョン**: v3.0.0
- **状態**: Draft
- **最終更新日**: 2026-01-28

## 2. 機能概要
`SessionManager` は、バックエンド実行（AIエージェントのプロセス）を「セッション」として抽象化し、管理するための機能である。
これにより、単純なプロセス実行から、`tmux` や `zellij` を利用した永続的なセッション、対話的なアタッチ機能までを一貫したインターフェースで提供する。

## 3. インターフェース定義

### 3.1. ISessionManager
すべてのセッション実装が遵守すべきインターフェース。

```typescript
interface ISessionManager {
  /**
   * 新しいセッションを作成し、コマンドを実行する
   */
  create(id: string, command: string, args: string[]): Promise<Session>;

  /**
   * 現在管理下のセッション一覧を取得する
   */
  list(): Promise<Session[]>;

  /**
   * 指定したセッションの出力を取得する
   * @param id セッションID
   * @param lines 取得する末尾の行数
   */
  getOutput(id: string, lines?: number): Promise<string>;

  /**
   * 指定したセッションの出力をリアルタイムにストリーミングする
   * @param id セッションID
   */
  streamOutput(id: string): AsyncIterable<string>;

  /**
   * 指定したセッションに対話的にアタッチする（CLI用）
   * @param id セッションID
   */
  attach(id: string): Promise<void>;

  /**
   * セッションが実行中かどうかを確認する
   * @param id セッションID
   */
  isRunning(id: string): Promise<boolean>;

  /**
   * セッションを強制終了する
   * @param id セッションID
   */
  kill(id: string): Promise<void>;
}
```

### 3.2. Session
セッションの状態を表すオブジェクト。

```typescript
interface Session {
  id: string;                         // セッションID (例: orch-123)
  type: 'native' | 'tmux' | 'zellij'; // 実装タイプ
  status: 'running' | 'stopped' | 'errored'; // 現在の状態
  command: string;                    // 実行コマンド
  startTime: Date;                    // 開始日時
}
```

## 4. セッション実装

管理対象の環境やユーザーの好みに応じて、以下の3つの実装を提供する。

| 実装 | 説明 |
|------|------|
| **NativeSessionManager** | 外部ツールに依存せず、Bun.spawn を直接利用してプロセスを管理する。CI環境等に適している。 |
| **TmuxSessionManager** | `tmux` を利用してセッションを管理する。永続性が高く、ターミナルから直接アタッチ可能。 |
| **ZellijSessionManager** | モダンなターミナルマルチプレクサ `zellij` を利用してセッションを管理する。 |

## 5. 自動検出ロジック

セッションマネージャーの選択は、以下の優先順位で自動的に行われる。

1. **明示的指定**: CLI オプション `--session-manager` または設定ファイルで指定されている場合、その実装を強制的に使用する。
2. **Tmux検出**: システムに `tmux` コマンドが存在する場合、`TmuxSessionManager` を選択する。
3. **Zellij検出**: システムに `zellij` コマンドが存在する場合、`ZellijSessionManager` を選択する。
4. **フォールバック**: いずれにも該当しない場合、または指定されたツールが利用不可能な場合は、`NativeSessionManager` を選択する。

## 6. ビジネスルール

- **BR-012-1**: デフォルトのセッション管理は自動検出（tmux > zellij > native）とする。
- **BR-012-2**: セッション名は原則として `orch-<issue番号>` 形式とする。
- **BR-012-3**: バックエンドの出力は、監視・ストリーミングのために 500ms 間隔でキャプチャする。
- **BR-012-4**: `LOOP_COMPLETE` キーワードを検出した場合、セッションマネージャーは正常終了としてセッションをクリーンアップする。
- **BR-012-5**: バックエンドが異常終了（エラー）した場合は、デバッグを容易にするためセッション（ログ等）を一定期間保持する。
- **BR-012-6**: `native` モードであっても、ストリーミングや出力取得などの基本機能は他のモードと同等に動作することを保証する。

## 7. CLIコマンド仕様

セッションを操作するための以下のコマンドを提供する。

| コマンド | 説明 |
|----------|------|
| `orch sessions` | 現在実行中のセッション一覧を表示する。出力にはID、タイプ、実行時間を含める。 |
| `orch attach <issue>` | 指定した Issue のセッションにアタッチし、対話操作を可能にする。 |
| `orch kill <issue>` | 指定した Issue のセッションを強制終了する。 |

## 8. 呼び出し元（Integration Points）⚠️ 必須

> **重要**: このセクションは Phase 6.6（設計書整合性チェック）で統合漏れを検出するために必須。

### 8.1 このモジュールを使用する場所

| 呼び出し元ファイル | 使用メソッド | 説明 | 統合Issue |
|------------------|-------------|------|----------|
| `src/cli.ts` (`run` コマンド) | `createSessionManager()`, `create()`, `isRunning()`, `getOutput()`, `kill()` | Issue実行時のセッション作成・監視 | - |
| `src/cli.ts` (`status` コマンド) | `createSessionManager()`, `isRunning()`, `list()` | セッション状態確認 | - |
| `src/cli.ts` (`logs` コマンド) | `createSessionManager()`, `list()` | ログ表示用セッション取得 | - |
| `src/cli.ts` (`sessions` コマンド) | `createSessionManager()`, `list()` | セッション一覧表示 | - |
| `src/cli.ts` (`attach` コマンド) | `createSessionManager()`, `isRunning()`, `attach()` | セッションへの対話的接続 | - |
| `src/cli.ts` (`kill` コマンド) | `createSessionManager()`, `isRunning()`, `kill()` | セッション強制終了 | - |
| `src/core/log-monitor.ts` | `ISessionManager` | ログ監視・ストリーミング | - |

### 8.2 統合確認コマンド

```bash
# SessionManager の使用箇所を確認
grep -rn 'SessionManager\|createSessionManager\|ISessionManager' src/

# 期待される出力:
# src/cli.ts: createSessionManager() 呼び出し（6箇所）
# src/core/log-monitor.ts: ISessionManager 使用
# src/adapters/session/: 実装ファイル群
```

### 8.3 この機能を使用する他のIssue

| Issue | 概要 | 統合ポイント |
|-------|------|-------------|
| - | - | - |

### 8.4 統合ステータス（実装時に更新）

| 統合ポイント | ステータス | 備考 |
|-------------|----------|------|
| `run` コマンドでのセッション作成 | ✅ 実装済み | L105-154 |
| `status` コマンドでの状態確認 | ✅ 実装済み | L156-171 |
| `logs` コマンドでのログ表示 | ✅ 実装済み | L173-205 |
| `sessions` コマンドでの一覧表示 | ✅ 実装済み | L207-214 |
| `attach` コマンドでのアタッチ | ✅ 実装済み | L216-232 |
| `kill` コマンドでの強制終了 | ✅ 実装済み | L234-250 |
| `LogMonitor` との連携 | ✅ 実装済み | src/core/log-monitor.ts |
