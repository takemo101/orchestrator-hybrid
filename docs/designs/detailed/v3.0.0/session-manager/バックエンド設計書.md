# バックエンド設計書: F-012 セッション管理

## 1. メタ情報
- **ドキュメントID**: DETAIL-ORCH-004-F012-BE-001
- **対象機能**: F-012 セッション管理（バックエンド実装）
- **バージョン**: v3.0.0
- **状態**: Draft
- **最終更新日**: 2026-01-28

## 2. 実装クラスの設計

### 2.1. NativeSessionManager
外部ツールに依存しない、Bun ランタイムの基本機能を利用した実装。

- **実行方式**: `Bun.spawn` を利用してバックエンドプロセスを直接起動する。
- **標準入出力管理**:
  - `stdout` および `stderr` をパイプし、`.agent/sessions/<id>/output.log` にアペンド形式で書き込む。
  - `stdin` は `ipc` またはパイプを通じて制御する。
- **状態監視**: `BunChildProcess.exited` プロミスを利用してプロセスの終了を検知する。
- **出力取得**: 
  - `getOutput` はログファイルの末尾を読み取る。
  - `streamOutput` は `fs.watch` を使用してファイル更新を検知し、新規追加分を `yield` する。

### 2.2. TmuxSessionManager
`tmux` コマンドを介してセッションを操作する実装。

- **セッション作成**: 
  - `tmux new-session -d -s <id> "<command> <args>"` を実行。
  - `-d` フラグによりバックグラウンド（デタッチ状態）で開始する。
- **出力キャプチャ**: 
  - `tmux capture-pane -t <id> -p` を使用してペインの内容をテキストとして取得する。
  - `streamOutput` 実装のため、500ms ごとにキャプチャを行い、差分を抽出するロジックを導入する。
- **アタッチ**: `process.inherit` 設定で `tmux attach-session -t <id>` を実行し、制御を tmux に渡す。
- **強制終了**: `tmux kill-session -t <id>` を実行。

### 2.3. ZellijSessionManager
`zellij` コマンドを介してセッションを操作する実装。

- **セッション作成**: `zellij run --name <id> -- <command> <args>` を使用して新しいペインまたはセッションで実行。
- **アタッチ**: `zellij attach <id>` を実行。
- **終了**: `zellij kill-session <id>` を実行。

## 3. セッションファクトリーパターン

セッションマネージャーの生成と自動検出をカプセル化する。

```typescript
class SessionManagerFactory {
  /**
   * 指定されたタイプ、または自動検出に基づいてマネージャーを生成する
   */
  static async create(type: string = 'auto'): Promise<ISessionManager> {
    if (type === 'native') return new NativeSessionManager();
    if (type === 'tmux') return new TmuxSessionManager();
    if (type === 'zellij') return new ZellijSessionManager();
    
    // 自動検出
    if (await this.canRun('tmux')) return new TmuxSessionManager();
    if (await this.canRun('zellij')) return new ZellijSessionManager();
    
    return new NativeSessionManager();
  }

  private static async canRun(command: string): Promise<boolean> {
    try {
      const proc = Bun.spawn([command, '--version']);
      const status = await proc.exited;
      return status === 0;
    } catch {
      return false;
    }
  }
}
```

## 4. ログファイル管理

永続化とデバッグのため、すべてのセッションは共通のログ構造を持つ。

### 4.1. ディレクトリ構造
- `.agent/sessions/<id>/output.log` - stdout/stderr の結合出力
- `.agent/sessions/<id>/session.json` - メタデータ (開始時間、コマンド、タイプ等)
- `.agent/sessions/<id>/exit_code` - 終了時のステータスコード (Native用)

### 4.2. キャプチャ間隔
- `TmuxSessionManager` および `ZellijSessionManager` において、外部から出力をスキャンする必要がある場合、**500ms** 間隔でのポーリングを実施する。
- `NativeSessionManager` はストリームから直接書き込むため、遅延なしでログに反映される。

## 5. エラーハンドリング

- **コマンド不在**: 検出されたマルチプレクサが実行中に削除された場合、即座にエラーをスローせず、可能な限り `NativeSessionManager` へのフォールバックを試みる。
- **セッション名衝突**: 既に同名のセッションが存在する場合、`kill` してから再作成するか、ユニークな接尾辞を付与する処理を行う（デフォルトは `kill` して再作成）。
