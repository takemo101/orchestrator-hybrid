# F-002 プロンプト生成 バックエンド設計書

## メタ情報

| 項目 | 内容 |
|------|------|
| ドキュメントID | DETAIL-ORCH-004-F002-BE-001 |
| バージョン | 1.0.0 |
| ステータス | 確定 |
| 作成日 | 2026-01-28 |
| 対応機能ID | F-002 |
| 作成者 | AI Assistant |

---

## 1. PromptGenerator クラス設計

プロンプト生成ロジックは `src/input/prompt-generator.ts` 内の `PromptGenerator` クラスに集約する。

### 1.1 プロパティ
- `templatePath: string`: 外部テンプレートファイルのパス。
- `defaultTemplate: string`: ファイルが読み込めない場合に使用するフォールバックテンプレート。

### 1.2 メソッド

#### `generate(issue: IssueInfo, context: HatContext): Promise<string>`
- **責務**: 変数展開を行い、最終的なプロンプト文字列を生成するメインエントリーポイント。
- **引数**:
  - `issue`: `IssueInfo` 型（タイトル、本文、ラベル等を含む）。
  - `context`: `HatContext` 型（現在のHat名、指示等を含む）。
- **戻り値**: 生成されたプロンプト文字列。

#### `loadTemplate(): Promise<string>`
- **責務**: `orch.yml` で指定されたテンプレートファイル、またはデフォルトの `.agent/templates/default.md` を読み込む。

#### `applyVariables(template: string, variables: Record<string, string>): string`
- **責務**: テンプレート内の `{{key}}` を `variables[key]` の値で置換する。

---

## 2. テンプレートエンジン仕様

実装のシンプルさを優先し、外部ライブラリは使用せず、TypeScriptの文字列操作（正規表現による置換）で実装する。

### 2.1 置換ルール
- 置換パターン: `/\{\{\s*(\w+)\s*\}\}/g`
- エスケープ処理: プロンプトはMarkdownとして出力されるため、HTMLエスケープ等は行わず、ソースのテキストをそのまま埋め込む。
- 未定義変数の扱い: 置換対象の変数が存在しない場合は、空文字列 `""` で置換する。

### 2.2 実装イメージ
```typescript
const result = template.replace(/\{\{\s*(\w+)\s*\}\}/g, (match, key) => {
  return variables[key] || "";
});
```

---

## 3. ファイル出力仕様

生成されたプロンプトは、AIバックエンドが直接参照する場所に保存する。

### 3.1 出力先
- パス: `.agent/PROMPT.md`
- 理由: 
  - プロジェクトルート直下の `.agent/` ディレクトリに隠しファイルとして配置し、開発作業を邪魔しないようにする。
  - `.gitignore` に追加されるべきファイルである。

### 3.2 保存タイミング
- `orch run` コマンド開始時
- Hatの切り替えが発生したタイミング（イテレーション開始前）

### 3.3 ファイルエンコーディング
- 文字コード: `UTF-8`
- 改行コード: `LF`（実行プラットフォームに依存せず統一）

### 3.4 後処理
- セッション終了時にこのファイルを削除するかどうかは、設定 `state.cleanup`（v3.0.0では手動削除推奨）に従う。デフォルトではデバッグのために残存させる。
