# F-002 プロンプト生成 詳細設計書

## メタ情報

| 項目 | 内容 |
|------|------|
| ドキュメントID | DETAIL-ORCH-004-F002-001 |
| バージョン | 1.0.0 |
| ステータス | 確定 |
| 作成日 | 2026-01-28 |
| 対応機能ID | F-002 |
| 作成者 | AI Assistant |

---

## 1. 機能概要

GitHub Issueから取得した情報（タイトル、本文、ラベル）と、現在の実行コンテキスト（Hat設定、プリセット）を組み合わせて、AIバックエンド（Claude/OpenCode）が解釈可能なMarkdown形式のプロンプトファイルを生成する。生成されたプロンプトは `.agent/PROMPT.md` に保存され、ループ実行エンジンによってバックエンドに渡される。

### 主要な役割
- **情報の構造化**: 雑多なIssue情報をAIが理解しやすい形式に整理する。
- **指示の注入**: 実行モード（Hat）に応じた具体的な指示をプロンプトに動的に追加する。
- **コンテキストの維持**: 前回の実行結果（イベント履歴など）を含めることで、AIの継続性を確保する（拡張用）。

---

## 2. 処理フロー

```mermaid
graph TD
    Start[プロンプト生成開始] --> LoadIssue[Issue情報の読み込み]
    LoadIssue --> LoadTemplate[テンプレートファイルのロード]
    LoadTemplate --> CheckHat{Hat設定が有効か?}
    
    CheckHat -- Yes --> AddHatInst[Hat固有の指示を追加]
    CheckHat -- No --> SkipHat[Hat指示をスキップ]
    
    AddHatInst --> ResolveVars[変数展開 {{variable}}]
    SkipHat --> ResolveVars
    
    ResolveVars --> Validate[生成内容のバリデーション]
    Validate --> WriteFile[".agent/PROMPT.md に書き込み"]
    WriteFile --> End[プロンプト生成完了]
```

---

## 3. テンプレート構造

プロンプトは以下の3つのセクションで構成される。

### 3.1 システムセクション (System Section)
AIの役割、基本ルール、およびorchestrator-hybridの動作仕様を定義する。
- `LOOP_COMPLETE` キーワードの使用方法
- ファイル操作のルール
- 思考プロセスの推奨

### 3.2 ユーザーリクエストセクション (User Request Section)
GitHub Issueから抽出された情報を配置する。
- Issueタイトル
- Issue本文
- 関連するラベル情報

### 3.3 コンテキスト/指示セクション (Instruction Section)
現在のHatに応じた具体的なタスク指示を配置する。
- 現在のHat名
- Hat固有の追加指示（例: 「テストを作成してください」）

---

## 4. 変数展開仕様

テンプレート内で使用可能な変数は以下の通り。`{{変数名}}` の形式で記述する。

| 変数名 | ソース | 説明 |
|-------|--------|------|
| `issue_number` | GitHub Issue | Issue番号 |
| `issue_title` | GitHub Issue | Issueタイトル |
| `issue_body` | GitHub Issue | Issue本文（Markdown形式） |
| `hat_name` | Hat System | 現在のHat名（例: Tester） |
| `hat_instructions`| Hat System | Hat固有の指示テキスト |
| `current_date` | System | 実行時の日付 |

---

## 5. エラーハンドリング

| ケース | 対応方針 |
|-------|----------|
| テンプレートファイル未検出 | デフォルトの組み込みテンプレートを使用し、警告ログを出力する。 |
| 必須変数の欠如 | Issueタイトルが空の場合はエラーとし、処理を中断する。 |
| 書き込み失敗 | `.agent/` ディレクトリの権限を確認し、致命的エラーとして停止する。 |
| 変数展開ループ | 同一変数の再帰展開は行わず、1段階の置換のみを実行する。 |
