# orchestrator-hybrid v3.0.0 インフラ設計書

## メタ情報

| 項目 | 内容 |
|------|------|
| ドキュメントID | DETAIL-ORCH-004-INFRA-001 |
| バージョン | 1.0.0 |
| 親設計書 | [基本設計書](../../../basic/BASIC-ORCH-004_v3.0.0.md) |
| 作成日 | 2026-01-28 |

---

## 1. 概要

### 1.1 インフラ方針

orchestrator-hybrid v3.0.0は**ローカル実行CLIツール**であり、サーバーインフラは不要。

| 項目 | 方針 |
|------|------|
| 実行環境 | ローカルマシン |
| デプロイ | npm/bunパッケージ配布 |
| 外部依存 | GitHub API、AIバックエンド |
| サーバー | **不要** |

### 1.2 実行環境要件

| ツール | バージョン | 必須 | 用途 |
|--------|-----------|:----:|------|
| Bun | 1.0+ | O | ランタイム |
| git | 2.5+ | O | worktree機能 |
| gh | 最新 | O | GitHub CLI |
| claude/opencode | 最新 | O | AIバックエンド |
| tmux | 3.0+ | - | セッション管理（オプション） |
| zellij | 最新 | - | セッション管理（オプション） |

---

## 2. ディレクトリ構造

### 2.1 プロジェクト構造

| ディレクトリ | ファイル | 説明 |
|-------------|---------|------|
| `src/` | `cli.ts` | CLIエントリーポイント |
| `src/` | `index.ts` | ライブラリエントリーポイント |
| `src/core/` | `config.ts` | 設定管理 |
| `src/core/` | `loop.ts` | ループエンジン |
| `src/core/` | `hat.ts` | Hatシステム |
| `src/core/` | `event.ts` | イベントバス |
| `src/core/` | `types.ts` | 型定義 |
| `src/adapters/` | `base.ts` | バックエンド基底クラス |
| `src/adapters/` | `claude.ts` | Claudeアダプター |
| `src/adapters/` | `opencode.ts` | OpenCodeアダプター |
| `src/session/` | `manager.ts` | ISessionManager |
| `src/session/` | `native.ts` | NativeSessionManager |
| `src/session/` | `tmux.ts` | TmuxSessionManager |
| `src/session/` | `zellij.ts` | ZellijSessionManager |
| `src/worktree/` | `manager.ts` | WorktreeManager |
| `src/input/` | `github.ts` | Issue取得 |
| `src/input/` | `prompt.ts` | プロンプト生成 |
| `src/input/` | `dependency.ts` | Issue依存関係 |
| `src/output/` | `pr.ts` | PR作成 |
| `src/output/` | `labels.ts` | ステータスラベル |
| `presets/` | `simple.yml` | simpleプリセット |
| `presets/` | `tdd.yml` | tddプリセット |
| `templates/` | `prompt.md` | プロンプトテンプレート |
| `/` | `orch.yml` | 設定ファイル |
| `/` | `package.json` | パッケージ定義 |
| `/` | `tsconfig.json` | TypeScript設定 |
| `/` | `biome.json` | Linter設定 |

### 2.2 ランタイムディレクトリ

| パス | 説明 |
|------|------|
| `.agent/PROMPT.md` | 生成されたプロンプト |
| `.agent/sessions/issue-{番号}/meta.json` | セッション情報 |
| `.agent/sessions/issue-{番号}/stdout.log` | 標準出力 |
| `.agent/sessions/issue-{番号}/stderr.log` | 標準エラー |
| `.agent/sessions/issue-{番号}/combined.log` | 統合ログ |
| `.agent/sessions/issue-{番号}/pid` | プロセスID |
| `.worktrees/issue-{番号}/` | git worktree（ソース、.env、.agent含む） |

---

## 3. 配布・インストール

### 3.1 パッケージ配布

| 方法 | コマンド | 対象 |
|------|---------|------|
| npm | `npm install -g orchestrator-hybrid` | 一般ユーザー |
| bun | `bun add -g orchestrator-hybrid` | Bunユーザー |
| ソース | `git clone && bun install && bun link` | 開発者 |

### 3.2 依存パッケージ

**Production Dependencies**:

| パッケージ | バージョン | 用途 |
|-----------|-----------|------|
| commander | ^12.0.0 | CLIフレームワーク |
| zod | ^3.0.0 | スキーマ検証 |
| chalk | ^5.0.0 | ターミナル色付け |
| yaml | ^2.0.0 | YAML解析 |

**Dev Dependencies**:

| パッケージ | バージョン | 用途 |
|-----------|-----------|------|
| typescript | ^5.0.0 | 型チェック |
| @types/bun | latest | Bun型定義 |
| biome | ^1.0.0 | Lint/Format |

---

## 4. 外部システム連携

### 4.1 GitHub API

| 用途 | エンドポイント | 認証 |
|------|--------------|------|
| Issue取得 | `gh issue view` | gh CLI |
| PR作成 | `gh pr create` | gh CLI |
| ラベル管理 | `gh issue edit --add-label` | gh CLI |

**認証フロー**:
```
ユーザー → gh auth login → OAuth/PAT → GitHub API
```

### 4.2 AIバックエンド

| バックエンド | コマンド | 認証 |
|------------|---------|------|
| Claude | `claude --prompt` | 環境変数 `ANTHROPIC_API_KEY` |
| OpenCode | `opencode --prompt` | 設定ファイル |

---

## 5. セキュリティ

### 5.1 認証情報管理

| 情報 | 保存場所 | 保護方法 |
|------|---------|---------|
| GitHub Token | `gh`が管理 | システムキーチェーン |
| API Key | `.env` | `.gitignore`に追加 |

### 5.2 ファイル権限

| ファイル | 権限 | 理由 |
|---------|------|------|
| `orch.yml` | 644 | 設定ファイル |
| `.env` | 600 | 機密情報 |
| `.agent/` | 755 | ランタイムデータ |

---

## 6. ログ・監視

### 6.1 ログレベル

| レベル | 用途 | 出力先 |
|-------|------|--------|
| ERROR | エラー | stderr |
| WARN | 警告 | stderr |
| INFO | 進捗 | stdout |
| DEBUG | デバッグ | `DEBUG=orch` 時のみ |

### 6.2 ログローテーション

**なし** - セッション終了時にユーザーが手動でクリーンアップ。

```bash
# セッションディレクトリ削除
rm -rf .agent/sessions/issue-42

# 全セッション削除
rm -rf .agent/sessions/*
```

---

## 7. パフォーマンス

### 7.1 目標値

| 指標 | 目標 | 測定方法 |
|------|------|---------|
| 起動時間 | 100ms以下 | `time orch --version` |
| メモリ使用量 | 100MB以下 | 通常実行時 |
| ディスク使用量 | 設定+ログ依存 | - |

### 7.2 最適化方針

| 項目 | 方針 |
|------|------|
| 遅延ロード | 必要なモジュールのみインポート |
| キャッシュ | Issue情報はキャッシュしない（常に最新取得） |
| 並列化 | Worktreeによる並列実行 |

---

## 8. CI/CD

### 8.1 GitHub Actions

```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
      - run: bun install
      - run: bun test
      - run: bun run lint
      - run: bun run typecheck
```

### 8.2 リリースフロー

```mermaid
flowchart LR
    DEV[開発] --> PR[Pull Request]
    PR --> CI[CI/Test]
    CI --> MERGE[マージ]
    MERGE --> TAG[タグ作成]
    TAG --> NPM[npm publish]
```

---

## 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|----------|--------|
| 1.0.0 | 2026-01-28 | 初版作成 | AI Assistant |
