# バックエンド設計書 - 承認ゲート (F-005)

## 1. メタ情報
- **ドキュメントID**: DETAIL-ORCH-004-F005-BE-001
- **機能ID**: F-005
- **バージョン**: v3.0.0
- **状態**: Draft
- **作成日**: 2026-01-28

## 2. クラス設計

### 2.1 ApprovalGate クラス
承認ゲートのロジックをカプセル化するクラス。

#### プロパティ
- `config: Config`: プロジェクト設定（タイムアウト値など）
- `isAuto: boolean`: `--auto` フラグの有無。コンストラクタで `LoopContext.autoMode` または `Config.run.auto_mode` から初期化される。

#### メソッド
- `ask(gateType: 'pre-loop' | 'post-completion' | 'before-pr', context: any): Promise<boolean>`
    - ユーザーに承認を求めるメインメソッド。
    - 処理内容:
        1. `this.isAuto` が `true` の場合は即座に `true` を返す。
        2. `gateType` に応じたメッセージと `context` 情報をコンソールに表示する。
        3. 標準入力（stdin）からの入力を待機する。
        4. 指定時間内に有効な入力があればその結果を、なければタイムアウトとして `false` を返す。

## 3. 実装詳細

### 3.1 標準入力からの読み取り
Bunの環境で動作することを前提とし、Node.js互換の `readline` モジュール、またはBunの `prompt` 関数（同期）を検討する。対話性を重視するため `readline` プロミス版のパターンを推奨する。

```typescript
import { createInterface } from "node:readline";

async function promptUser(message: string, timeoutMs: number): Promise<string> {
  const rl = createInterface({
    input: process.stdin,
    output: process.stdout,
  });

  return new Promise((resolve) => {
    const timer = setTimeout(() => {
      rl.close();
      console.log("\n[Timeout] 承認がタイムアウトしました。デフォルトで拒否(n)として扱います。");
      resolve("n");
    }, timeoutMs);

    rl.question(message, (answer) => {
      clearTimeout(timer);
      rl.close();
      resolve(answer.trim().toLowerCase());
    });
  });
}
```

### 3.2 タイムアウト処理
- **デフォルトタイムアウト**: 1800秒 (30分)
- タイムアウト発生時は、`F-012 セッション管理` を通じて現在の進捗を `orphans` 状態として保存し、プロセスを安全に終了（中断）させる。

### 3.3 CLIにおける対話
- TTY（対話型端末）でない環境（CIなど）で、かつ `--auto` フラグがない場合に承認ゲートに到達した場合は、実行を継続できないためエラー（`ApprovalGateError`）をスローして停止する。

## 4. 依存関係
- `src/core/types.ts`: `Config`, `LoopContext` などの型定義
- `src/core/logger.ts`: 視覚的な警告やメッセージの出力
- `src/core/session-manager.ts`: 中断時のセッション状態保存（ISessionManagerの実装）
- `src/core/errors.ts`: `ApprovalGateError` の定義
