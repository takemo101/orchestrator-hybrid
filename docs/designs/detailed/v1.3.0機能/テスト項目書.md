# v1.3.0機能 テスト項目書

## メタ情報

| 項目 | 内容 |
|------|------|
| ドキュメントID | TEST-ORCH-002 |
| バージョン | 1.0.0 |
| ステータス | ドラフト |
| 作成日 | 2026-01-25 |
| 最終更新日 | 2026-01-25 |
| 作成者 | AI Assistant |
| 関連詳細設計書 | DETAILED-ORCH-002-F009〜F012 |

---

## 1. テスト方針

### 1.1 テストレベル

| レベル | 対象 | 担当 |
|--------|------|------|
| 単体テスト（UT） | 各クラス・関数 | 開発者 |
| 統合テスト（IT） | モジュール間連携 | 開発者 |
| E2Eテスト | CLIコマンド実行 | 開発者 |

### 1.2 テストフレームワーク

- **Bun Test**: 単体テスト・統合テスト
- **手動テスト**: E2Eテスト（GitHub実環境）

### 1.3 カバレッジ目標

| 対象 | 目標 |
|------|------|
| 行カバレッジ | 80%以上 |
| 分岐カバレッジ | 70%以上 |

---

## 2. F-009 PR自動マージ機能

### 2.1 単体テスト

| ID | テストケース | 入力 | 期待結果 | 優先度 |
|----|-------------|------|---------|--------|
| UT-F009-001 | CI成功時にマージ実行 | CI成功、enabled=true | マージ成功、true返却 | 高 |
| UT-F009-002 | CI失敗時にエラー | CI失敗 | PRAutoMergeErrorスロー | 高 |
| UT-F009-003 | タイムアウト時にエラー | タイムアウト発生 | PRAutoMergeErrorスロー | 高 |
| UT-F009-004 | enabled=false時はスキップ | enabled=false | false返却、マージ未実行 | 高 |
| UT-F009-005 | deleteBranch=false | deleteBranch=false | --delete-branchなし | 中 |
| UT-F009-006 | mergeMethod=rebase | mergeMethod="rebase" | --rebaseオプション | 中 |
| UT-F009-007 | mergeMethod=merge | mergeMethod="merge" | --mergeオプション | 中 |
| UT-F009-008 | マージ失敗時にエラー | マージコマンド失敗 | PRAutoMergeErrorスロー | 高 |

### 2.2 統合テスト

| ID | テストケース | 前提条件 | 期待結果 | 優先度 |
|----|-------------|---------|---------|--------|
| IT-F009-001 | Loop Engine統合 | PR作成後 | ラベルがmergedに更新 | 高 |
| IT-F009-002 | CLI --auto-mergeオプション | オプション指定 | 設定が適用される | 高 |
| IT-F009-003 | 設定ファイル優先順位 | CLI + 設定ファイル | CLIが優先 | 中 |

---

## 3. F-010 リアルタイムログ監視機能

### 3.1 単体テスト

| ID | テストケース | 入力 | 期待結果 | 優先度 |
|----|-------------|------|---------|--------|
| UT-F010-001 | ログファイル監視開始 | 有効なtaskId | 監視開始、コールバック呼び出し | 高 |
| UT-F010-002 | ログファイル不存在 | 存在しないパス | LogMonitorErrorスロー | 高 |
| UT-F010-003 | 新規行追加時にコールバック | ファイルに行追加 | コールバックに行が渡される | 高 |
| UT-F010-004 | stop()で監視終了 | stop()呼び出し | 監視が停止 | 高 |
| UT-F010-005 | ポーリングモード | fs.watch失敗 | ポーリングにフォールバック | 中 |
| UT-F010-006 | 部分行の処理 | 改行なしデータ | 次回読み取りで結合 | 中 |

### 3.2 統合テスト

| ID | テストケース | 前提条件 | 期待結果 | 優先度 |
|----|-------------|---------|---------|--------|
| IT-F010-001 | CLI logs --follow | タスク実行中 | リアルタイムでログ出力 | 高 |
| IT-F010-002 | CLI logs --task | 完了タスク | 過去ログ表示 | 高 |
| IT-F010-003 | Ctrl+Cで終了 | 監視中 | 正常終了 | 中 |

---

## 4. F-011 Issue依存関係管理機能

### 4.1 単体テスト

| ID | テストケース | 入力 | 期待結果 | 優先度 |
|----|-------------|------|---------|--------|
| UT-F011-001 | 依存関係取得 | Issue番号 | DependencyNode返却 | 高 |
| UT-F011-002 | 依存なしIssue | 依存なし | blockedBy=[], blocking=[] | 高 |
| UT-F011-003 | トポロジカルソート | 3 Issue（依存あり） | 正しい順序で返却 | 高 |
| UT-F011-004 | 循環依存検出 | A->B->C->A | CircularDependencyErrorスロー | 高 |
| UT-F011-005 | 単一Issueはそのまま | 1 Issue | 入力と同じ配列 | 中 |
| UT-F011-006 | 空配列は空配列 | [] | [] | 低 |
| UT-F011-007 | 依存完了チェック（完了） | 全依存closed | true返却 | 高 |
| UT-F011-008 | 依存完了チェック（未完了） | 依存にopen有 | false返却 | 高 |
| UT-F011-009 | 依存レポート生成 | Issue番号 | フォーマット済みレポート | 中 |

### 4.2 統合テスト

| ID | テストケース | 前提条件 | 期待結果 | 優先度 |
|----|-------------|---------|---------|--------|
| IT-F011-001 | --resolve-deps | 依存未完了 | 依存Issueを先に実行 | 高 |
| IT-F011-002 | --ignore-deps | 依存未完了 | 依存を無視して実行 | 高 |
| IT-F011-003 | --check-deps | 依存あり | レポート出力、終了コード返却 | 高 |
| IT-F011-004 | デフォルト動作 | 依存未完了 | エラー終了 | 高 |
| IT-F011-005 | 排他オプションエラー | --resolve + --ignore | エラー出力 | 中 |

---

## 5. F-012 Issueステータスラベル機能

### 5.1 単体テスト

| ID | テストケース | 入力 | 期待結果 | 優先度 |
|----|-------------|------|---------|--------|
| UT-F012-001 | ラベル初期化（新規作成） | ラベルなし | gh label create呼び出し | 高 |
| UT-F012-002 | ラベル初期化（既存スキップ） | ラベル存在 | 作成スキップ | 高 |
| UT-F012-003 | ステータス更新 | running | 旧ラベル削除+新ラベル追加 | 高 |
| UT-F012-004 | enabled=false | enabled=false | 何も実行しない | 高 |
| UT-F012-005 | カスタムプレフィックス | prefix="custom" | custom:running形式 | 中 |
| UT-F012-006 | 現在ステータス取得 | ラベルあり | 対応するIssueStatus返却 | 中 |
| UT-F012-007 | 現在ステータス取得（なし） | ラベルなし | null返却 | 中 |
| UT-F012-008 | エラー時も継続（ベストエフォート） | API失敗 | 例外スローなし | 高 |

### 5.2 統合テスト

| ID | テストケース | 前提条件 | 期待結果 | 優先度 |
|----|-------------|---------|---------|--------|
| IT-F012-001 | タスク開始時 | タスク実行 | running ラベル付与 | 高 |
| IT-F012-002 | タスク完了時 | タスク成功 | completed ラベル付与 | 高 |
| IT-F012-003 | タスク失敗時 | タスクエラー | failed ラベル付与 | 高 |
| IT-F012-004 | PR作成時 | PR作成成功 | pr-created ラベル付与 | 高 |
| IT-F012-005 | マージ完了時 | 自動マージ成功 | merged ラベル付与 | 高 |
| IT-F012-006 | init --labels | コマンド実行 | 全ラベル作成 | 中 |

---

## 6. 共通機能

### 6.1 型定義テスト

| ID | テストケース | 入力 | 期待結果 | 優先度 |
|----|-------------|------|---------|--------|
| UT-COM-001 | PRConfigSchemaデフォルト値 | {} | デフォルト値適用 | 高 |
| UT-COM-002 | ciTimeoutSecs範囲外（下限） | 30 | バリデーションエラー | 中 |
| UT-COM-003 | ciTimeoutSecs範囲外（上限） | 5000 | バリデーションエラー | 中 |
| UT-COM-004 | mergeMethod不正値 | "invalid" | バリデーションエラー | 中 |
| UT-COM-005 | label_prefixデフォルト | {} | "orch" | 高 |
| UT-COM-006 | label_prefix長さ制限（空） | "" | バリデーションエラー | 中 |
| UT-COM-007 | label_prefix長さ制限（超過） | 21文字 | バリデーションエラー | 中 |

### 6.2 エラークラステスト

| ID | テストケース | 入力 | 期待結果 | 優先度 |
|----|-------------|------|---------|--------|
| UT-ERR-001 | PRAutoMergeError生成 | message, details | 正しいcode, details | 高 |
| UT-ERR-002 | LogMonitorError生成 | message, details | 正しいcode, details | 高 |
| UT-ERR-003 | CircularDependencyError生成 | message, details | 正しいcode, details | 高 |
| UT-ERR-004 | IssueDependencyError生成 | message, details | 正しいcode, details | 高 |
| UT-ERR-005 | SandboxError継承確認 | 各エラー | instanceof SandboxError | 中 |

### 6.3 セキュリティテスト

| ID | テストケース | 入力 | 期待結果 | 優先度 |
|----|-------------|------|---------|--------|
| UT-SEC-001 | GitHubトークンマスク | ghp_xxx | [GH_TOKEN] | 高 |
| UT-SEC-002 | PATトークンマスク | github_pat_xxx | [GH_PAT] | 高 |
| UT-SEC-003 | APIキーマスク | sk-xxx | [API_KEY] | 高 |
| UT-SEC-004 | パスワードマスク | password=secret | password=[MASKED] | 高 |
| UT-SEC-005 | 通常テキスト | hello world | 変更なし | 中 |

---

## 7. E2Eテスト

### 7.1 シナリオテスト

| ID | シナリオ | 手順 | 期待結果 | 優先度 |
|----|---------|------|---------|--------|
| E2E-001 | 完全自動実行フロー | Issue作成→orch run --auto --create-pr --auto-merge | PR作成→CI待機→マージ完了 | 高 |
| E2E-002 | 依存関係解決フロー | 依存Issue設定→orch run --resolve-deps | 依存Issue先に実行 | 高 |
| E2E-003 | ログ監視フロー | タスク実行→別ターミナルでlogs --follow | リアルタイムログ表示 | 高 |
| E2E-004 | ラベル遷移確認 | タスク実行→GitHub確認 | running→completed遷移 | 高 |

---

## 8. テスト環境

### 8.1 必要条件

- Bun 1.0以上
- gh CLI（認証済み）
- テスト用GitHubリポジトリ

### 8.2 モック戦略

| 対象 | モック方法 |
|------|-----------|
| ProcessExecutor | DI経由でモック注入 |
| gh CLI | spawn結果をモック |
| fs.watch | Bunのモック機能 |

---

## 9. テスト実行

### 9.1 コマンド

```bash
# 全テスト実行
bun test

# 特定ファイル
bun test src/output/pr-auto-merger.test.ts

# カバレッジ付き
bun test --coverage
```

### 9.2 CI統合

```yaml
# .github/workflows/test.yml
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
      - run: bun install
      - run: bun test --coverage
```

---

## 10. 変更履歴

| バージョン | 日付 | 変更内容 | 変更者 |
|-----------|------|---------|--------|
| 1.0.0 | 2026-01-25 | 初版作成 | AI Assistant |
