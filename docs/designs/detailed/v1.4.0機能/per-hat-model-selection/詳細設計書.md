# Per-Hat Model Selection è©³ç´°è¨­è¨ˆæ›¸

## ãƒ¡ã‚¿æƒ…å ±

| é …ç›® | å†…å®¹ |
|------|------|
| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID | DETAILED-ORCH-004-F013 |
| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | 1.0.0 |
| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | ãƒ‰ãƒ©ãƒ•ãƒˆ |
| ä½œæˆæ—¥ | 2026-01-26 |
| æœ€çµ‚æ›´æ–°æ—¥ | 2026-01-26 |
| ä½œæˆè€… | AI Assistant |
| æ‰¿èªè€… | - |
| é–¢é€£åŸºæœ¬è¨­è¨ˆæ›¸ | BASIC-ORCH-004 v1.0.0 |
| å¯¾è±¡æ©Ÿèƒ½ | F-013 |

---

## 1. æ¦‚è¦

### 1.1 ç›®çš„

Hatæ¯ã«ç•°ãªã‚‹AIãƒ¢ãƒ‡ãƒ«ï¼ˆopus/sonnet/haikuï¼‰ã‚’æŒ‡å®šå¯èƒ½ã«ã—ã€ã‚³ã‚¹ãƒˆæœ€é©åŒ–ã¨ã‚¿ã‚¹ã‚¯ç‰¹åŒ–ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

### 1.2 ã‚¹ã‚³ãƒ¼ãƒ—

#### ã‚¹ã‚³ãƒ¼ãƒ—å†…

- Hatæ¯ã®ãƒ¢ãƒ‡ãƒ«æŒ‡å®šï¼ˆ`hats.<hat>.model`ï¼‰
- ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«ï¼ˆ`backend.model`ï¼‰
- ãƒ¢ãƒ‡ãƒ«è§£æ±ºå„ªå…ˆåº¦ï¼ˆHatå›ºæœ‰ â†’ ã‚°ãƒ­ãƒ¼ãƒãƒ« â†’ CLIãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
- Claude Code CLIã®ãƒ¢ãƒ‡ãƒ«ã‚¨ã‚¤ãƒªã‚¢ã‚¹å¯¾å¿œï¼ˆopus/sonnet/haikuï¼‰
- ãƒ•ãƒ«ãƒ¢ãƒ‡ãƒ«åå¯¾å¿œï¼ˆclaude-sonnet-4-5-20250929ï¼‰

#### ã‚¹ã‚³ãƒ¼ãƒ—å¤–

- ãƒ¢ãƒ‡ãƒ«ã®è‡ªå‹•é¸æŠï¼ˆã‚³ã‚¹ãƒˆ/æ€§èƒ½ã«åŸºã¥ãï¼‰
- ãƒ¢ãƒ‡ãƒ«ä½¿ç”¨é‡ã®è¿½è·¡
- ãƒ¢ãƒ‡ãƒ«åˆ‡ã‚Šæ›¿ãˆã®å‹•çš„æœ€é©åŒ–

### 1.3 å‚ç…§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | ãƒ‘ã‚¹ | å‚ç…§ç®‡æ‰€ |
|-------------|------|---------|
| åŸºæœ¬è¨­è¨ˆæ›¸ | docs/designs/basic/BASIC-ORCH-004_v1.4.0æ©Ÿèƒ½.md | ã‚»ã‚¯ã‚·ãƒ§ãƒ³3.2 |
| æ—¢å­˜Hatå®Ÿè£… | src/core/hat.ts | å‚è€ƒå®Ÿè£… |

---

## 2. å‡¦ç†ãƒ•ãƒ­ãƒ¼

### 2.1 å…¨ä½“ãƒ•ãƒ­ãƒ¼

```mermaid
flowchart TD
    A[Hatå®Ÿè¡Œé–‹å§‹] --> B{hats.<hat>.modelå®šç¾©?}
    B -->|Yes| C[Hatå›ºæœ‰ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨]
    B -->|No| D{backend.modelå®šç¾©?}
    D -->|Yes| E[ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨]
    D -->|No| F[CLIãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: sonnet]
    C --> G[ãƒ¢ãƒ‡ãƒ«åã‚’--modelãƒ•ãƒ©ã‚°ã«æ¸¡ã™]
    E --> G
    F --> G
    G --> H[Claude Code CLIå®Ÿè¡Œ]
    H --> I[Hatå‡¦ç†å®Œäº†]
```

### 2.2 ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³

```mermaid
sequenceDiagram
    autonumber
    participant Loop as LoopEngine
    participant Selector as ModelSelector
    participant Hat as HatExecutor
    participant CLI as Claude Code CLI

    Loop->>Selector: resolveModel(hatName)
    
    alt Hatå›ºæœ‰ãƒ¢ãƒ‡ãƒ«å®šç¾©ã‚ã‚Š
        Selector->>Selector: hats.<hat>.model ã‚’å–å¾—
        Selector-->>Loop: "opus"
    else ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¢ãƒ‡ãƒ«å®šç¾©ã‚ã‚Š
        Selector->>Selector: backend.model ã‚’å–å¾—
        Selector-->>Loop: "sonnet"
    else ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        Selector-->>Loop: "sonnet"
    end
    
    Loop->>Hat: execute(model="opus")
    Hat->>CLI: claude --model opus ...
    CLI-->>Hat: å®Ÿè¡Œçµæœ
    Hat-->>Loop: å®Œäº†
```

---

## 3. ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©

### 3.1 ModelSelector

ãƒ¢ãƒ‡ãƒ«è§£æ±ºãƒ­ã‚¸ãƒƒã‚¯ã‚’æ‹…å½“ã™ã‚‹ã‚¯ãƒ©ã‚¹ã€‚

```typescript
/**
 * Hatæ¯ã®ãƒ¢ãƒ‡ãƒ«é¸æŠã‚’è§£æ±ºã™ã‚‹ã‚¯ãƒ©ã‚¹
 */
export class ModelSelector {
  /**
   * ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
   * @param config - orchestratorè¨­å®š
   */
  constructor(config: Config);

  /**
   * æŒ‡å®šã•ã‚ŒãŸHatã®ãƒ¢ãƒ‡ãƒ«ã‚’è§£æ±º
   * 
   * å„ªå…ˆé †ä½:
   * 1. hats.<hat>.model
   * 2. backend.model
   * 3. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆsonnetï¼‰
   * 
   * @param hatName - Hatå
   * @returns ãƒ¢ãƒ‡ãƒ«åï¼ˆopus/sonnet/haiku ã¾ãŸã¯ãƒ•ãƒ«ãƒ¢ãƒ‡ãƒ«åï¼‰
   */
  resolveModel(hatName: string): string;
}
```

### 3.2 HatConfigæ‹¡å¼µ

```typescript
/**
 * Hatè¨­å®šï¼ˆv1.4.0æ‹¡å¼µï¼‰
 */
export interface HatConfig {
  name: string;
  triggers: string[];
  publishes: string[];
  instructions: string;
  
  // v1.4.0è¿½åŠ 
  /**
   * ã“ã®Hatå°‚ç”¨ã®ãƒ¢ãƒ‡ãƒ«
   * æœªæŒ‡å®šã®å ´åˆã¯ backend.model ã‚’ç¶™æ‰¿
   */
  model?: string;
}
```

---

## 4. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µ

### 4.1 orch.yml

```yaml
# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¨­å®š
backend:
  type: claude
  model: sonnet  # ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

# Hatå®šç¾©
hats:
  planner:
    name: "ğŸ“‹ Planner"
    model: opus  # è¨ˆç”»ãƒ•ã‚§ãƒ¼ã‚ºã¯é«˜æ€§èƒ½ãƒ¢ãƒ‡ãƒ«
    triggers: ["task.start"]
    publishes: ["plan.ready"]
    instructions: |
      ã‚¿ã‚¹ã‚¯ã®è¨ˆç”»ã‚’ç«‹ã¦ã‚‹
  
  implementer:
    name: "ğŸ”¨ Implementer"
    # modelçœç•¥ â†’ backend.model (sonnet) ã‚’ç¶™æ‰¿
    triggers: ["plan.ready"]
    publishes: ["code.written"]
    instructions: |
      è¨ˆç”»ã«åŸºã¥ã„ã¦å®Ÿè£…ã™ã‚‹
  
  reviewer:
    name: "ğŸ” Reviewer"
    model: haiku  # ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯è»½é‡ãƒ¢ãƒ‡ãƒ«ã§é«˜é€ŸåŒ–
    triggers: ["code.written"]
    publishes: ["review.approved", "LOOP_COMPLETE"]
    instructions: |
      å®Ÿè£…ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹
```

### 4.2 HatConfigSchemaï¼ˆzodï¼‰

```typescript
export const HatConfigSchema = z.object({
  name: z.string(),
  triggers: z.array(z.string()),
  publishes: z.array(z.string()),
  instructions: z.string(),
  
  // v1.4.0è¿½åŠ 
  model: z.string().optional(),
});

export type HatConfig = z.infer<typeof HatConfigSchema>;
```

---

## 5. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 5.1 ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹

| ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ | ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ | å¯¾å‡¦ |
|-------------|----------------|------|
| ãƒ¢ãƒ‡ãƒ«åãŒä¸æ­£ | `ä¸æ­£ãªãƒ¢ãƒ‡ãƒ«å: ${model}ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆsonnetï¼‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚` | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ |
| Claude CLIãŒåˆ©ç”¨ä¸å¯ | `Claude Code CLIãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚` | å®Ÿè¡Œã‚’ä¸­æ–­ |

### 5.2 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ–¹é‡

- ãƒ¢ãƒ‡ãƒ«åãŒä¸æ­£ãªå ´åˆ: è­¦å‘Šãƒ­ã‚°ã‚’å‡ºåŠ›ã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«ï¼ˆsonnetï¼‰ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
- Claude CLIãŒåˆ©ç”¨ä¸å¯ã®å ´åˆ: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’å‡ºåŠ›ã—ã€å®Ÿè¡Œã‚’ä¸­æ–­

---

## 6. CLIçµ±åˆ

### 6.1 æ–°è¦ã‚ªãƒ—ã‚·ãƒ§ãƒ³

```bash
# Hatå›ºæœ‰ã®ãƒ¢ãƒ‡ãƒ«ã‚’ä¸Šæ›¸ã
orch run --issue 42 --model opus
```

| ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | èª¬æ˜ |
|-----------|------|
| `--model <model>` | ã™ã¹ã¦ã®Hatã§ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’ä¸Šæ›¸ã |

### 6.2 è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¨ã®å„ªå…ˆé †ä½

1. CLIã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆ`--model`ï¼‰
2. Hatå›ºæœ‰è¨­å®šï¼ˆ`hats.<hat>.model`ï¼‰
3. ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šï¼ˆ`backend.model`ï¼‰
4. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆ`sonnet`ï¼‰

---

## 7. Loop Engineçµ±åˆ

### 7.1 çµ±åˆãƒã‚¤ãƒ³ãƒˆ

```typescript
// src/core/loop.ts

export async function runLoop(context: LoopContext): Promise<LoopResult> {
  const modelSelector = new ModelSelector(context.config);
  
  // Hatå®Ÿè¡Œæ™‚ã«ãƒ¢ãƒ‡ãƒ«ã‚’è§£æ±º
  for (const hat of hats) {
    const model = context.overrideModel ?? modelSelector.resolveModel(hat.name);
    
    logger.info(`Hat: ${hat.name}, Model: ${model}`);
    
    const result = await executeHat(hat, model, context);
    // ...
  }
  
  return result;
}
```

---

## 8. ãƒ†ã‚¹ãƒˆæ–¹é‡

### 8.1 å˜ä½“ãƒ†ã‚¹ãƒˆ

| ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ | æœŸå¾…çµæœ |
|-------------|---------|
| Hatå›ºæœ‰ãƒ¢ãƒ‡ãƒ«å®šç¾©ã‚ã‚Š | Hatå›ºæœ‰ãƒ¢ãƒ‡ãƒ«ã‚’è¿”ã™ |
| Hatå›ºæœ‰ãƒ¢ãƒ‡ãƒ«æœªå®šç¾©ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¢ãƒ‡ãƒ«ã‚ã‚Š | ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¢ãƒ‡ãƒ«ã‚’è¿”ã™ |
| ã™ã¹ã¦æœªå®šç¾© | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆsonnetï¼‰ã‚’è¿”ã™ |
| ä¸æ­£ãªãƒ¢ãƒ‡ãƒ«å | è­¦å‘Šãƒ­ã‚°ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ |

### 8.2 çµ±åˆãƒ†ã‚¹ãƒˆ

| ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ | æœŸå¾…çµæœ |
|-------------|---------|
| `--model opus`ãƒ•ãƒ©ã‚° | ã™ã¹ã¦ã®Hatã§opusã‚’ä½¿ç”¨ |
| è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ | è¨­å®šå€¤ãŒé©ç”¨ã•ã‚Œã‚‹ |

---

## 9. å®Ÿè£…ã‚¿ã‚¹ã‚¯

| ã‚¿ã‚¹ã‚¯ID | ã‚¿ã‚¹ã‚¯å†…å®¹ | è¦‹ç©ã‚‚ã‚Š |
|---------|-----------|---------|
| TASK-013-1 | ModelSelectorã‚¯ãƒ©ã‚¹å®Ÿè£… | 2h |
| TASK-013-2 | HatConfigSchemaæ‹¡å¼µ | 1h |
| TASK-013-3 | Loop Engineçµ±åˆ | 2h |
| TASK-013-4 | CLI `--model`ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¿½åŠ  | 1h |
| TASK-013-5 | å˜ä½“ãƒ†ã‚¹ãƒˆä½œæˆ | 2h |
| TASK-013-6 | çµ±åˆãƒ†ã‚¹ãƒˆä½œæˆ | 2h |

---

## 10. å¤‰æ›´å±¥æ­´

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ—¥ä»˜ | å¤‰æ›´å†…å®¹ | å¤‰æ›´è€… |
|-----------|------|---------|--------|
| 1.0.0 | 2026-01-26 | åˆç‰ˆä½œæˆ | AI Assistant |
