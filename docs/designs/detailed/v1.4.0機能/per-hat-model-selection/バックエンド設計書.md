# Per-Hat Model Selection バックエンド設計書

## メタ情報

| 項目 | 内容 |
|------|------|
| ドキュメントID | DETAILED-ORCH-004-F013-BE |
| バージョン | 1.0.0 |
| ステータス | ドラフト |
| 作成日 | 2026-01-26 |
| 最終更新日 | 2026-01-26 |
| 作成者 | AI Assistant |
| 承認者 | - |
| 関連詳細設計書 | DETAILED-ORCH-004-F013 |
| 対象機能 | F-013 |

---

## 1. 概要

Per-Hat Model Selection機能のバックエンド実装仕様を定義します。

---

## 2. ファイル構成

| ファイル | 説明 | 新規/変更 |
|---------|------|----------|
| `src/core/model-selector.ts` | ModelSelectorクラス | 新規 |
| `src/core/model-selector.test.ts` | 単体テスト | 新規 |
| `src/core/types.ts` | HatConfigSchema拡張 | 変更 |
| `src/cli.ts` | `--model`オプション追加 | 変更 |
| `src/core/loop.ts` | ModelSelector統合 | 変更 |

---

## 3. クラス詳細設計

### 3.1 ModelSelector

#### ファイル: `src/core/model-selector.ts`

```typescript
import { Config, HatConfig } from "./types.js";
import { logger } from "./logger.js";

/**
 * Hat毎のモデル選択を解決するクラス
 * 
 * @example
 * ```typescript
 * const selector = new ModelSelector(config);
 * const model = selector.resolveModel("planner");
 * // => "opus" (hats.planner.model が定義されている場合)
 * // => "sonnet" (backend.model が定義されている場合)
 * // => "sonnet" (デフォルト)
 * ```
 */
export class ModelSelector {
  private readonly config: Config;
  private readonly defaultModel = "sonnet";

  constructor(config: Config) {
    this.config = config;
  }

  /**
   * 指定されたHatのモデルを解決
   * 
   * 優先順位:
   * 1. hats.<hat>.model
   * 2. backend.model
   * 3. デフォルト（sonnet）
   * 
   * @param hatName - Hat名
   * @returns モデル名（opus/sonnet/haiku またはフルモデル名）
   */
  resolveModel(hatName: string): string {
    // 1. Hat固有のモデル
    const hatConfig = this.config.hats?.[hatName];
    if (hatConfig?.model) {
      logger.debug(`Hat "${hatName}" uses model: ${hatConfig.model}`);
      return this.validateModel(hatConfig.model);
    }

    // 2. グローバルデフォルトモデル
    if (this.config.backend?.model) {
      logger.debug(`Hat "${hatName}" uses global model: ${this.config.backend.model}`);
      return this.validateModel(this.config.backend.model);
    }

    // 3. デフォルト
    logger.debug(`Hat "${hatName}" uses default model: ${this.defaultModel}`);
    return this.defaultModel;
  }

  /**
   * モデル名を検証
   * 
   * @param model - モデル名
   * @returns 検証済みモデル名（不正な場合はデフォルト）
   */
  private validateModel(model: string): string {
    // エイリアス（opus/sonnet/haiku）またはフルモデル名を許可
    const validAliases = ["opus", "sonnet", "haiku"];
    const isAlias = validAliases.includes(model);
    const isFullName = model.startsWith("claude-");

    if (isAlias || isFullName) {
      return model;
    }

    logger.warn(
      `不正なモデル名: ${model}。デフォルト（${this.defaultModel}）を使用します。`
    );
    return this.defaultModel;
  }

  /**
   * すべてのHatのモデルマッピングを取得（デバッグ用）
   * 
   * @returns Hat名 → モデル名のマッピング
   */
  getAllModels(): Record<string, string> {
    const result: Record<string, string> = {};
    
    if (this.config.hats) {
      for (const hatName of Object.keys(this.config.hats)) {
        result[hatName] = this.resolveModel(hatName);
      }
    }
    
    return result;
  }
}
```

---

## 4. 型定義拡張

### ファイル: `src/core/types.ts`（追加分）

```typescript
/**
 * Hat設定のzodスキーマ（v1.4.0拡張）
 */
export const HatConfigSchema = z.object({
  name: z.string(),
  triggers: z.array(z.string()),
  publishes: z.array(z.string()),
  instructions: z.string(),
  
  // v1.4.0追加
  /**
   * このHat専用のモデル
   * 未指定の場合は backend.model を継承
   */
  model: z.string().optional(),
});

export type HatConfig = z.infer<typeof HatConfigSchema>;

/**
 * LoopContext拡張（v1.4.0）
 */
export interface LoopContext {
  // ... 既存フィールド

  /**
   * すべてのHatで使用するモデルを上書き（--modelオプション）
   */
  overrideModel?: string;
}
```

---

## 5. CLI統合

### ファイル: `src/cli.ts`（変更分）

```typescript
program
  .command("run")
  // ... 既存オプション
  .option("--model <model>", "すべてのHatで使用するモデルを上書き（opus/sonnet/haiku）")
  .action(async (options) => {
    // ... 既存処理

    // LoopContextに渡す
    const context: LoopContext = {
      // ... 既存フィールド
      overrideModel: options.model, // 追加
    };

    // ... 既存処理
  });
```

---

## 6. Loop Engine統合

### ファイル: `src/core/loop.ts`（変更分）

```typescript
import { ModelSelector } from "./model-selector.js";

export async function runLoop(context: LoopContext): Promise<LoopResult> {
  const modelSelector = new ModelSelector(context.config);
  
  // デバッグ: すべてのHatのモデルマッピングを表示
  if (context.verbose) {
    const allModels = modelSelector.getAllModels();
    logger.debug("Hat Model Mapping:", allModels);
  }
  
  // Hat実行時にモデルを解決
  for (const hat of hats) {
    // --modelオプションが指定されている場合は優先
    const model = context.overrideModel ?? modelSelector.resolveModel(hat.name);
    
    logger.info(`Executing Hat: ${hat.name} with model: ${model}`);
    
    // バックエンドアダプターにモデルを渡す
    const result = await executeHat(hat, {
      ...context,
      model, // モデルを渡す
    });
    
    // ... 既存処理
  }
  
  return result;
}
```

---

## 7. バックエンドアダプター統合

### ファイル: `src/adapters/claude.ts`（変更分）

```typescript
export class ClaudeAdapter extends BaseAdapter {
  async execute(prompt: string, context: LoopContext): Promise<ProcessResult> {
    const args = [
      // ... 既存引数
    ];

    // モデル指定（v1.4.0）
    if (context.model) {
      args.push("--model", context.model);
    }

    return this.executor.spawn("claude", args);
  }
}
```

---

## 8. テスト設計

### 8.1 単体テスト

#### ファイル: `src/core/model-selector.test.ts`

```typescript
import { describe, test, expect } from "bun:test";
import { ModelSelector } from "./model-selector.js";
import type { Config } from "./types.js";

describe("ModelSelector", () => {
  test("Hat固有のモデルを返す", () => {
    const config: Config = {
      backend: { type: "claude", model: "sonnet" },
      hats: {
        planner: {
          name: "Planner",
          model: "opus",
          triggers: [],
          publishes: [],
          instructions: "",
        },
      },
    };

    const selector = new ModelSelector(config);
    expect(selector.resolveModel("planner")).toBe("opus");
  });

  test("グローバルモデルを返す", () => {
    const config: Config = {
      backend: { type: "claude", model: "sonnet" },
      hats: {
        implementer: {
          name: "Implementer",
          triggers: [],
          publishes: [],
          instructions: "",
        },
      },
    };

    const selector = new ModelSelector(config);
    expect(selector.resolveModel("implementer")).toBe("sonnet");
  });

  test("デフォルトモデルを返す", () => {
    const config: Config = {
      backend: { type: "claude" },
      hats: {
        reviewer: {
          name: "Reviewer",
          triggers: [],
          publishes: [],
          instructions: "",
        },
      },
    };

    const selector = new ModelSelector(config);
    expect(selector.resolveModel("reviewer")).toBe("sonnet");
  });

  test("不正なモデル名はデフォルトにフォールバック", () => {
    const config: Config = {
      backend: { type: "claude", model: "invalid-model" },
      hats: {},
    };

    const selector = new ModelSelector(config);
    expect(selector.resolveModel("any")).toBe("sonnet");
  });

  test("フルモデル名を許可", () => {
    const config: Config = {
      backend: { type: "claude", model: "claude-sonnet-4-5-20250929" },
      hats: {},
    };

    const selector = new ModelSelector(config);
    expect(selector.resolveModel("any")).toBe("claude-sonnet-4-5-20250929");
  });

  test("getAllModels()でマッピングを取得", () => {
    const config: Config = {
      backend: { type: "claude", model: "sonnet" },
      hats: {
        planner: {
          name: "Planner",
          model: "opus",
          triggers: [],
          publishes: [],
          instructions: "",
        },
        implementer: {
          name: "Implementer",
          triggers: [],
          publishes: [],
          instructions: "",
        },
      },
    };

    const selector = new ModelSelector(config);
    const allModels = selector.getAllModels();
    
    expect(allModels).toEqual({
      planner: "opus",
      implementer: "sonnet",
    });
  });
});
```

---

## 9. 実装メモ

### 9.1 モデルエイリアス

Claude Code CLIがサポートするエイリアス:
- `opus` → `claude-opus-4-20250514`
- `sonnet` → `claude-sonnet-4-20250514`
- `haiku` → `claude-haiku-4-20250514`

### 9.2 フルモデル名

フルモデル名も許可:
- `claude-sonnet-4-5-20250929`
- `claude-opus-4-20250514`

### 9.3 デフォルトモデル

すべて未指定の場合は `sonnet` をデフォルトとする。

---

## 10. 変更履歴

| バージョン | 日付 | 変更内容 | 変更者 |
|-----------|------|---------|--------|
| 1.0.0 | 2026-01-26 | 初版作成 | AI Assistant |
